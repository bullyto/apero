<script>
  // Commander
  document.getElementById("goBtn").addEventListener("click", () => {
    window.location.href = "https://aperodenuit.com/commander";
  });

  // D√©filement bouteilles (2s)
  const imgs = document.querySelectorAll("#bottles img");
  let idx = 0;
  if (imgs.length > 1) {
    setInterval(() => {
      imgs[idx].classList.remove("active");
      idx = (idx + 1) % imgs.length;
      imgs[idx].classList.add("active");
    }, 2000);
  }

  // D√©tections
  const ua = navigator.userAgent || "";
  const isFBInApp = /FBAN|FBAV|FB_IAB|FB4A|FB4i|Instagram/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

  // PWA prompt Android/Chrome
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  // Toast
  const toastEl = document.getElementById("toast");
  function showToast(msg){
    if(msg) toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove("show"), 2600);
  }

  // ‚úÖ Standalone detection
  function isStandalone(){
    return window.matchMedia("(display-mode: standalone)").matches
      || window.navigator.standalone === true; // iOS
  }

  // ‚úÖ Cache TOUT le bouton (pas juste badge/pulse)
  function removeInstallHints(){
    const b = document.getElementById("newBadge");
    if (b) b.remove();

    const installBtn = document.getElementById("installBtn");
    if (installBtn) {
      installBtn.classList.remove("pulse");
      installBtn.style.display = "none"; // ‚úÖ le bouton dispara√Æt
    }
  }

  // Si d√©j√† en mode app => on cache direct
  if (isStandalone()) removeInstallHints();

  // Quand l'app est install√©e (Android/Chrome)
  window.addEventListener("appinstalled", () => {
    showToast("üéâ Ap√©ro de Nuit est ajout√© √† ton √©cran d‚Äôaccueil !");
    removeInstallHints();
  });

  // Modale helpers
  const modal = document.getElementById("helpModal");
  const closeBtn = document.getElementById("closeHelp");
  const copyBtn = document.getElementById("copyLinkBtn");
  const copiedMsg = document.getElementById("copiedMsg");
  const intro = document.getElementById("helpIntro");
  const steps = document.getElementById("helpSteps");
  const title = document.getElementById("helpTitle");
  const icon = document.getElementById("helpIcon");

  function openModal({t="Installer l‚Äôapp", i="", s="", showCopy=false, ic="üì≤"}) {
    title.textContent = t;
    icon.textContent = ic;
    intro.innerHTML = i;
    steps.innerHTML = s;
    copyBtn.style.display = showCopy ? "inline-block" : "none";
    copiedMsg.style.display = "none";
    modal.classList.add("open");
  }

  closeBtn.addEventListener("click", () => modal.classList.remove("open"));
  modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("open"); });

  // Copier lien (avec fallback)
  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      copiedMsg.style.display = "block";
    } catch (e) {
      const tmp = document.createElement("textarea");
      tmp.value = window.location.href;
      document.body.appendChild(tmp);
      tmp.select();
      document.execCommand("copy");
      document.body.removeChild(tmp);
      copiedMsg.style.display = "block";
    }
  });

  // Mini diagnostic (quand Chrome ne donne pas beforeinstallprompt)
  function buildInstallDiagHTML(){
    const isHttps = location.protocol === "https:";
    const inIncognitoHint = "Si tu es en navigation priv√©e, Chrome bloque souvent l‚Äôinstallation.";
    return (
      "<strong>V√©rifie :</strong><br><br>" +
      "‚Ä¢ HTTPS : " + (isHttps ? "‚úÖ" : "‚ùå") + "<br>" +
      "‚Ä¢ Manifest charg√© (pas 404) ‚úÖ<br>" +
      "‚Ä¢ Service Worker enregistr√© + actif ‚úÖ<br>" +
      "‚Ä¢ Ic√¥nes 192/512 accessibles ‚úÖ<br>" +
      "‚Ä¢ scope/start_url coh√©rents ‚úÖ<br><br>" +
      "<em>Astuce cache :</em> supprime les donn√©es du site + d√©sinscris le service worker, puis ouvre l‚ÄôURL avec <strong>?v=123</strong>.<br><br>" +
      "<em>" + inIncognitoHint + "</em>"
    );
  }

  // Click "Ajouter l‚Äôapp"
  document.getElementById("installBtn").addEventListener("click", async () => {

    // Si on est d√©j√† en mode app, on cache et basta
    if (isStandalone()) {
      removeInstallHints();
      return;
    }

    // Facebook/Instagram in-app : modale + copier lien
    if (isFBInApp) {
      openModal({
        ic:"üì£",
        t:"Ouvrir dans un navigateur",
        i:"Facebook / Instagram bloque l‚Äôinstallation de l‚Äôapp.",
        s:
          "<strong>Solution :</strong><br><br>" +
          "1) Clique sur <strong>Copier le lien</strong><br>" +
          "2) Ouvre <strong>Chrome</strong> (Android) ou <strong>Safari</strong> (iPhone)<br>" +
          "3) Colle le lien dans la barre d‚Äôadresse, puis re-clique sur <strong>Ajouter l‚Äôapp</strong>",
        showCopy:true
      });
      return;
    }

    // Si popup native dispo : on d√©clenche UNIQUEMENT la popup
    if (deferredPrompt) {
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch(e) {}
      deferredPrompt = null;
      return;
    }

    // iPhone Safari : instructions Apple (pas de popup native)
    if (isIOS && isSafari) {
      openModal({
        ic:"üçè",
        t:"Ajouter √† l‚Äô√©cran d‚Äôaccueil",
        i:"Sur iPhone, l‚Äôinstallation se fait via le bouton Partager.",
        s:
          "<strong>√âtapes :</strong><br><br>" +
          "1) Appuie sur <strong>Partager</strong> (carr√© + fl√®che)<br>" +
          "2) Choisis <strong>Sur l‚Äô√©cran d‚Äôaccueil</strong><br>" +
          "3) Valide <strong>Ajouter</strong>"
      });
      return;
    }

    // Autres cas : message utile + copier lien + diag
    openModal({
      ic:"‚ö†Ô∏è",
      t:"Installation indisponible",
      i:"Ton navigateur ne propose pas l‚Äôinstallation automatique.",
      s:
        "Essaie avec <strong>Chrome</strong> (Android) ou <strong>Safari</strong> (iPhone).<br>" +
        "Si tu es sur une appli (Facebook, etc.), ouvre le lien dans un navigateur.<br><br>" +
        buildInstallDiagHTML(),
      showCopy:true
    });
  });
</script>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>L'ap√©ro catalan¬Æ</title>

  <!-- PWA / UI -->
  <meta name="theme-color" content="#8a0b0b">
  <meta name="background-color" content="#2a0a0c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ap√©ro Catalan¬Æ">

  <!-- ‚úÖ Cache-busting -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- ‚úÖ icons locales -->
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <!-- ‚úÖ Partage / preview -->
  <meta property="og:title" content="L'ap√©ro catalan¬Æ">
  <meta property="og:description" content="√âpicerie de nuit catalan ‚Ä¢ Livraison 7j/7 de 19h √† 6h ‚Ä¢ Appel direct">
  <meta property="og:image" content="./icon-512.png?v=20251223">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="L'ap√©ro catalan¬Æ">
  <meta name="twitter:description" content="√âpicerie de nuit catalan ‚Ä¢ Livraison 7j/7 de 19h √† 6h ‚Ä¢ Appel direct">
  <meta name="twitter:image" content="./icon-512.png?v=20251223">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">

  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors: { primary: '#C61910', secondary: '#FFB81C' },
        borderRadius: {
          'none': '0px','sm': '4px',DEFAULT: '8px','md': '12px','lg': '16px','xl': '20px',
          '2xl': '24px','3xl': '32px','full': '9999px','button': '8px'
        }
      }
    }
  }
  </script>

  <style>

/* PATCH V6: search input full width and readable */
#searchInput{
  width:100% !important;
  max-width:100% !important;
  font-size:14px !important;
}



/* PATCH V6: hide misleading count line */
#countLine, .countLine, .articlesCount { display:none !important; }



/* =========================
   CORE UI REWORK (V5)
========================= */
.stockNote.premium{
  display:flex; gap:10px; align-items:center;
  margin:12px 0 14px; padding:12px 14px;
  border-radius:14px;
  background:linear-gradient(135deg, rgba(180,0,0,.08), rgba(0,0,0,.04));
  border:1px solid rgba(180,0,0,.18);
}
.stockNote .icon{
  width:10px;height:10px;border-radius:50%;
  background:#b00000; flex:0 0 auto;
}
.stockNote .txt strong{display:block;font-size:14px}
.stockNote .txt span{font-size:12px;opacity:.85}


/* =========================
   BANNI√àRE STOCK (3 √©tats)
   LIVE / PR√âPARATION / HORS LIGNE
   (stock alcool uniquement)
========================= */
.liveBanner{
  width:100%;
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  margin:12px 0 14px; padding:12px 14px;border-radius:16px;
  border:1px solid rgba(198,25,16,.18);
  background:linear-gradient(135deg, rgba(198,25,16,.10), rgba(255,184,28,.10));
  box-shadow:0 10px 30px rgba(0,0,0,.06);
}
.liveLeft{display:flex;align-items:center;gap:10px;min-width:0}
.liveDot{
  width:10px;height:10px;border-radius:999px;background:#C61910;
  box-shadow:0 0 0 0 rgba(198,25,16,.55);
  animation:livePulse 1.2s infinite;
}
@keyframes livePulse{
  0%{box-shadow:0 0 0 0 rgba(198,25,16,.55)}
  70%{box-shadow:0 0 0 10px rgba(198,25,16,0)}
  100%{box-shadow:0 0 0 0 rgba(198,25,16,0)}
}
.liveTitle{font-weight:950;letter-spacing:.12em;font-size:12px;color:#7a0b0b}
.liveSub{font-size:12px;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.liveChip{
  font-weight:950;font-size:12px;letter-spacing:.08em;
  padding:6px 10px;border-radius:999px;color:#fff;background:#C61910;
}
/* Variantes */
.liveBanner.offline{
  background:linear-gradient(135deg, rgba(0,0,0,.06), rgba(0,0,0,.03));
  border-color:rgba(0,0,0,.10);
}
.liveBanner.offline .liveDot{background:#111;animation:none;box-shadow:none}
.liveBanner.offline .liveChip{background:#111}
.liveBanner.prep .liveDot{background:#FFB81C;animation:none;box-shadow:none}
.liveBanner.prep .liveChip{background:#FFB81C;color:#1b0b0b}


/* Grid locked mobile-first */
.grid, .productsGrid{
  display:grid !important;
  grid-template-columns: repeat(2, minmax(0,1fr)) !important;
  gap:14px !important;
}

/* Product card */
.productCard, .card{
  display:flex; flex-direction:column;
  align-items:center;
  padding:14px 12px;
  border-radius:16px;
  background:#fff;
  box-shadow:0 6px 20px rgba(0,0,0,.06);
  overflow:hidden;
}

/* Bottle image dominant */
.productCard img, .card img{
  width:84px; height:150px;
  object-fit:contain;
  margin-bottom:10px;
}

/* Title */
.productCard h3, .card h3{
  font-size:14px;
  font-weight:700;
  text-align:center;
  line-height:1.2;
  margin:4px 0 6px;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* Price line */
.price, .productPrice{
  display:flex; align-items:baseline; gap:6px;
  font-size:18px; font-weight:800; color:#b00000;
  margin:6px 0;
}
.price .euro{font-size:14px}

/* Availability badge */
.stockBadge{
  margin:6px 0 10px;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px; font-weight:800;
}
.stockBadge.ok{
  background:rgba(0,150,80,.15);
  color:#0a6a3a;
}
.stockBadge.no{
  background:rgba(200,0,0,.15);
  color:#a00000;
}

/* Button */
.productCard .btn, .card button{
  margin-top:auto;
  width:100%;
  border-radius:12px;
  font-weight:700;
}

/* Search spacing */
.searchBar{margin:10px 0 12px}

/* Category tabs breathing */
.tabs{margin:10px 0 14px}

/* Safety */
*{box-sizing:border-box}



/* === PATCH V4: prevent overflow inside modal cards === */
.stockNote{
  margin: 10px 0 12px;
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.04);
  border: 1px solid rgba(0,0,0,.08);
  color: #222;
  font-size: 13px;
  line-height: 1.25;
}
.stockNote strong{font-size: 13px;}
.stockNote span{opacity:.9}

/* Cards / grid safety */
.grid, .cardsGrid, .productsGrid, .productGrid{
  grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
}
.productCard, .product-card, .itemCard, .item-card, .cardProduct, .card{
  min-width: 0 !important;
  max-width: 100% !important;
  overflow: hidden !important;
}
.productCard * , .product-card * , .itemCard * , .item-card * , .cardProduct * , .card *{
  min-width: 0 !important;
}

/* Bigger bottle images but constrained */
.productCard img, .product-card img, .itemCard img, .item-card img, .cardProduct img, img.productImg{
  width: 64px !important;
  height: 108px !important;
  max-width: 100% !important;
  object-fit: contain !important;
  display:block !important;
  margin: 0 auto !important;
}

/* Title clamp to avoid overflow */
.productCard .name, .product-card .name, .itemCard .name, .item-card .name,
.productCard h3, .product-card h3, .itemCard h3, .item-card h3,
.productCard .title, .product-card .title, .itemCard .title, .item-card .title{
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  word-break: break-word !important;
}

/* Price + ‚Ç¨ same line */
.price, .productPrice, .priceLine, .prix, .product-prix{
  display: inline-flex !important;
  align-items: baseline !important;
  gap: 6px !important;
  white-space: nowrap !important;
}
.euro{display:inline !important}

/* Availability badge visibility */
.avail, .availability, .stockBadge, .stockPill, .etatStock{
  display:inline-flex !important;
  align-items:center !important;
  padding: 6px 10px !important;
  border-radius: 999px !important;
  font-weight: 900 !important;
  font-size: 12px !important;
  line-height: 1 !important;
}
.avail.ok, .availability.ok, .stockBadge.ok, .etatStock.ok{ background: rgba(0,160,80,.14) !important; color:#0b6b3a !important; border:1px solid rgba(0,160,80,.25) !important; }
.avail.no, .availability.no, .stockBadge.no, .etatStock.no{ background: rgba(220,0,0,.14) !important; color:#a30000 !important; border:1px solid rgba(220,0,0,.25) !important; }

/* Modal padding to keep inside */
.modal, .sheet, .dialog, .popup{
  box-sizing: border-box !important;
}


    :where([class^="ri-"])::before { content: "\f3c2"; }
    .modal { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal.active { opacity: 1; pointer-events: auto; }
    .tab-active { background:#C61910 !important; color:#fff !important; }
    .tab-idle { background:#f3f4f6 !important; color:#111827 !important; }

    /* ===== PWA FAUX CHARGEMENT (uniquement PWA install√©e) ===== */
    #pwaLoading {
      position: fixed;
      inset: 0;
      z-index: 999999;
      display: none; /* activ√© uniquement en mode PWA */
      opacity: 0;
      transition: opacity .18s ease; /* fondu-in court */
    }
    #pwaLoading.ready { opacity: 1; }
    #pwaLoading .pl-body{
      height:100%;
      overflow:hidden;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:
        radial-gradient(900px 650px at 50% 18%, rgba(255,211,107,.18), transparent 58%),
        radial-gradient(900px 650px at 20% 70%, rgba(177,15,21,.20), transparent 62%),
        radial-gradient(900px 650px at 80% 70%, rgba(242,178,51,.12), transparent 62%),
        linear-gradient(180deg, #5a1217, #2a0a0c 55%, #120406);
    }
    #pwaLoading .pl-stripes{
      position:absolute; inset:-40%;
      background: repeating-linear-gradient(90deg, rgba(177,15,21,.12) 0 42px, rgba(242,178,51,.10) 42px 84px);
      transform: rotate(-12deg);
      opacity:.35;
      animation: pl-drift 8s ease-in-out infinite;
      mix-blend-mode: overlay;
      pointer-events:none;
    }
    @keyframes pl-drift{
      0%,100%{transform: rotate(-12deg) translateX(-1.4%)}
      50%{transform: rotate(-12deg) translateX(1.4%)}
    }
    #pwaLoading .pl-vignette{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 38%, transparent 35%, rgba(0,0,0,.50) 92%);
      pointer-events:none;
    }
    #pwaLoading .pl-screen{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    #pwaLoading .pl-brand{
      position:absolute;
      top:18px;
      width:100%;
      text-align:center;
      font-weight:900;
      letter-spacing:.18em;
      color:rgba(255,244,223,.95);
      font-size:19px;
      text-shadow:0 6px 24px rgba(0,0,0,.45);
      user-select:none;
    }
    #pwaLoading .pl-brand sup{
      font-size:12px;
      margin-left:3px;
      vertical-align:text-top;
      letter-spacing:0;
    }
    #pwaLoading .pl-stack{
      width:min(420px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
      transform: translateY(-10px);
    }
    #pwaLoading .pl-iconWrap{
      width:168px; height:168px;
      display:grid;
      place-items:center;
      border-radius:36px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 95px rgba(0,0,0,.55);
      position:relative;
      animation: pl-float 3.2s ease-in-out infinite;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    #pwaLoading .pl-iconWrap::before{
      content:"";
      position:absolute; inset:-20px;
      background: radial-gradient(circle at 50% 50%, rgba(255,211,107,.28), transparent 60%);
      filter: blur(16px);
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    #pwaLoading .pl-iconWrap::after{
      content:"";
      position:absolute;
      top:-40%;
      left:-70%;
      width:60%;
      height:220%;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.18) 40%, rgba(255,255,255,.35) 50%, rgba(255,255,255,.18) 60%, transparent 100%);
      transform: skewX(-18deg);
      filter: blur(1px);
      opacity:.75;
      animation: pl-logoShine 3.6s ease-in-out infinite;
      pointer-events:none;
      z-index:2;
      mix-blend-mode: screen;
    }
    @keyframes pl-logoShine{
      0%   { left:-75%; opacity:0; }
      18%  { opacity:.85; }
      50%  { opacity:.75; }
      82%  { opacity:.85; }
      100% { left:125%; opacity:0; }
    }
    #pwaLoading .pl-icon{
      width:132px; height:132px;
      object-fit:contain;
      border-radius:30px;
      background:#fff;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,.35));
      position:relative;
      z-index:1;
    }
    @keyframes pl-float{
      0%,100%{transform: translateY(0)}
      50%{transform: translateY(-5px)}
    }
    #pwaLoading .pl-progressRow{
      width:270px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
    }
    #pwaLoading .pl-percent{
      font-size:13px;
      color:rgba(255,255,255,.72);
      letter-spacing:.2px;
      user-select:none;
    }
    #pwaLoading .pl-track{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    #pwaLoading .pl-bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #d98912, #f2b233, #ffd36b);
      transition: width .25s linear;
      box-shadow: 0 0 18px rgba(255,211,107,.18);
      position:relative;
    }
    #pwaLoading .pl-bar:after{
      content:"";
      position:absolute;
      top:-70%;
      left:-55%;
      width:46%;
      height:240%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.24), transparent);
      transform: skewX(-16deg);
      animation: pl-sweep 1.6s linear infinite;
      opacity:.65;
    }
    @keyframes pl-sweep{
      0%{left:-55%}
      100%{left:130%}
    }
    @media (prefers-reduced-motion: reduce){
      #pwaLoading .pl-stripes,
      #pwaLoading .pl-iconWrap,
      #pwaLoading .pl-iconWrap::after,
      #pwaLoading .pl-bar:after { animation:none !important; }
    }

    /* =========================
       üîû AGE GATE (harmonis√© Ap√©ro Catalan)
       - M√™me m√©thode que ton autre page (localStorage + until + action pending)
       ========================= */
    .ageOverlay{
      position: fixed;
      inset: 0;
      z-index: 999998; /* sous faux chargement, au-dessus du reste */
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .ageOverlay.show{ display:flex; }

    .ageCard{
      width: min(560px, 94vw);
      border-radius: 24px;
      overflow: hidden;
      color: #fff;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      background:
        radial-gradient(900px 650px at 50% 18%, rgba(255,211,107,.18), transparent 58%),
        radial-gradient(900px 650px at 20% 70%, rgba(198,25,16,.22), transparent 62%),
        radial-gradient(900px 650px at 80% 70%, rgba(255,184,28,.14), transparent 62%),
        linear-gradient(180deg, #5a1217, #2a0a0c 55%, #120406);
    }
    .ageTop{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .ageBrand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .ageBadge{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight: 950;
      letter-spacing: .06em;
      background: rgba(198,25,16,.20);
      border: 1px solid rgba(198,25,16,.38);
      color: #fff;
      flex: 0 0 auto;
    }
    .ageBrand b{
      letter-spacing:.10em;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(255,244,223,.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ageBody{ padding: 18px; }
    .ageTitle{ margin: 6px 0 10px; font-size: 28px; line-height:1.1; font-weight: 950; }
    .ageLead{ margin: 0 0 14px; color: rgba(255,255,255,.78); line-height: 1.45; font-size: 15px; }
    .ageNotice{
      margin: 14px 0 16px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      font-size: 14px;
      line-height: 1.35;
    }
    .ageBtns{ display:grid; gap: 10px; margin-top: 10px; }
    .ageBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      padding: 14px 14px;
      border-radius: 16px;
      cursor: pointer;
      font-weight: 950;
      font-size: 15px;
    }
    .ageBtnPrimary{
      background: linear-gradient(180deg, rgba(198,25,16,1), rgba(138,11,11,1));
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 16px 48px rgba(198,25,16,.28);
    }
    .ageBtnSecondary{
      background: linear-gradient(180deg, rgba(255,184,28,1), rgba(217,137,18,1));
      color: #1b0b0b;
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 16px 48px rgba(255,184,28,.22);
    }
    .ageTimer{
      margin-top: 12px;
      font-weight: 950;
      color: rgba(255,211,107,.95);
      text-align: center;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .ageFine{
      margin: 12px 0 0;
      color: rgba(255,255,255,.62);
      font-size: 12.5px;
      line-height: 1.35;
      text-align: center;
    }
    .ageFine a{ color:#ffd36b; text-decoration:none; font-weight: 900; }
    .ageFine a:hover{ text-decoration: underline; }

    /* ===== PLAY STORE CTA (site only) ===== */
    .playstore-white-btn{
      border: 1px solid rgba(0,0,0,.08);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .playstore-white-btn:active{
      transform: scale(0.99);
    }
    @keyframes playPulseAlt{
      0%{ box-shadow: 0 0 0 0 rgba(255,184,28,.55), 0 10px 26px rgba(0,0,0,.08); }
      45%{ box-shadow: 0 0 0 14px rgba(255,184,28,0), 0 10px 26px rgba(0,0,0,.08); }
      50%{ box-shadow: 0 0 0 0 rgba(198,25,16,.55), 0 10px 26px rgba(0,0,0,.08); }
      95%{ box-shadow: 0 0 0 14px rgba(198,25,16,0), 0 10px 26px rgba(0,0,0,.08); }
      100%{ box-shadow: 0 0 0 0 rgba(255,184,28,.55), 0 10px 26px rgba(0,0,0,.08); }
    }
    .playstore-pulse{
      animation: playPulseAlt 1.6s ease-in-out infinite;
    }

  
/* ===== Google Play badge (site-only) ===== */
.playstore-badge{
  position: relative;
  text-decoration: none;
  transition: transform .15s ease, filter .15s ease;
}
.playstore-badge:active{ transform: scale(.98); }
.playstore-triangle{
  width: 22px;
  height: 22px;
  display: inline-block;
  border-radius: 6px;
  background:
    conic-gradient(from 210deg,
      #34A853 0 90deg,
      #FBBC05 90deg 180deg,
      #EA4335 180deg 270deg,
      #4285F4 270deg 360deg);
  clip-path: polygon(22% 12%, 88% 50%, 22% 88%, 36% 50%);
  filter: saturate(1.1);
}
.playstore-pulse::before{
  content:"";
  position:absolute;
  inset:-10px;
  border-radius: 999px;
  pointer-events:none;
  opacity:.65;
  animation: playstorePulse 6.5s ease-in-out infinite;
}
@keyframes playstorePulse{
  /* Pulse tr√®s doux : jaune -> rouge, lent */
  0%{
    box-shadow: 0 0 0 0 rgba(255,193,7,.10), 0 0 10px 0 rgba(255,193,7,.05);
    opacity:.16;
  }
  24%{
    box-shadow: 0 0 0 8px rgba(255,193,7,.04), 0 0 18px 0 rgba(255,193,7,.06);
    opacity:.28;
  }
  49%{
    box-shadow: 0 0 0 12px rgba(255,193,7,.02), 0 0 20px 0 rgba(255,193,7,.05);
    opacity:.20;
  }
  50%{
    box-shadow: 0 0 0 0 rgba(198,25,16,.10), 0 0 10px 0 rgba(198,25,16,.05);
    opacity:.16;
  }
  74%{
    box-shadow: 0 0 0 8px rgba(198,25,16,.04), 0 0 18px 0 rgba(198,25,16,.06);
    opacity:.28;
  }
  100%{
    box-shadow: 0 0 0 12px rgba(198,25,16,.02), 0 0 20px 0 rgba(198,25,16,.05);
    opacity:.20;
  }
}

25%{
    box-shadow: 0 0 0 10px rgba(255,193,7,.06), 0 0 26px 0 rgba(255,193,7,.10);
    opacity:.55;
  }
  49%{
    box-shadow: 0 0 0 14px rgba(255,193,7,.03), 0 0 30px 0 rgba(255,193,7,.08);
    opacity:.40;
  }
  50%{
    box-shadow: 0 0 0 0 rgba(198,25,16,.16), 0 0 18px 0 rgba(198,25,16,.10);
    opacity:.35;
  }
  75%{
    box-shadow: 0 0 0 10px rgba(198,25,16,.06), 0 0 26px 0 rgba(198,25,16,.10);
    opacity:.55;
  }
  100%{
    box-shadow: 0 0 0 14px rgba(198,25,16,.03), 0 0 30px 0 rgba(198,25,16,.08);
    opacity:.40;
  }
}

</style>
</head>

<body class="w-full max-w-[430px] min-h-[100svh] mx-auto relative"
  style="background-image:url('https://readdy.ai/api/search-image?query=blurred%20background%2C%20warm%20and%20festive%20atmosphere%2C%20people%20celebrating%2C%20soft%20lights%2C%20party%20mood%2C%20warm%20colors%2C%20subtle%20pattern%2C%20low%20opacity%20for%20text%20readability%2C%20no%20distinct%20objects&width=375&height=762&seq=10&orientation=portrait'); background-size:cover; background-position:center;">

<!-- ‚úÖ PWA : Faux chargement (uniquement si l'app est install√©e) -->
<div id="pwaLoading" aria-hidden="true">
  <div class="pl-body">
    <div class="pl-stripes"></div>
    <div class="pl-vignette"></div>

    <div class="pl-screen">
      <div class="pl-brand">APERO CATALAN<sup>¬Æ</sup></div>

      <div class="pl-stack">
        <div class="pl-iconWrap">
          <img class="pl-icon"
               src="./icon-512.png?v=20251223"
               onerror="this.onerror=null; this.src='https://image.noelshack.com/fichiers/2025/52/2/1766528997-icon-512-1.png';"
               alt="Ap√©ro Catalan">
        </div>

        <div class="pl-progressRow">
          <div class="pl-percent" id="plPct">0%</div>
          <div class="pl-track"><div class="pl-bar" id="plBar"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Afficher le faux chargement UNIQUEMENT en PWA install√©e ===== */
(function(){
  const isStandalone =
    window.matchMedia('(display-mode: standalone)').matches ||
    window.matchMedia('(display-mode: fullscreen)').matches ||
    window.matchMedia('(display-mode: minimal-ui)').matches ||
    window.navigator.standalone === true;

  const overlay = document.getElementById('pwaLoading');
  if (!overlay) return;

  if (!isStandalone) {
    overlay.remove(); // Site navigateur => jamais de faux chargement
    return;
  }

  overlay.style.display = 'block';
  requestAnimationFrame(() => overlay.classList.add('ready'));

  const bar = document.getElementById('plBar');
  const pct = document.getElementById('plPct');
  let p = 0;

  function setP(v){
    p = Math.max(0, Math.min(100, v));
    if (bar) bar.style.width = p + '%';
    if (pct) pct.textContent = Math.round(p) + '%';
  }

  const t = setInterval(() => {
    if (p < 40) setP(p + 1.2);
    else if (p < 70) setP(p + 0.85);
    else if (p < 88) setP(p + 0.42);
    else if (p < 96) setP(p + 0.16);
    else setP(p + 0.05);
    if (p >= 99) setP(99);
  }, 5);

  window.addEventListener('load', () => {
  updatePlayBadgeVisibility();
clearInterval(t);
    setTimeout(() => {
      setP(100);
      overlay.style.transition = 'opacity .25s ease';
      overlay.style.opacity = '0';
      setTimeout(() => overlay.remove(), 260);
    }, 2100);
  
  try {
    const mm = window.matchMedia('(display-mode: standalone)');
    mm?.addEventListener?.('change', updatePlayBadgeVisibility);
  } catch(e){}
  document.addEventListener('visibilitychange', updatePlayBadgeVisibility);
});
})();
</script>

<header class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm">
  <div class="w-full max-w-[430px] mx-auto py-4 flex items-center justify-center">
    <div class="text-center">
      <div class="w-[150px] h-[150px] mx-auto mb-2 rounded-full overflow-hidden">
        <img id="logo-entreprise"
             src="https://i.postimg.cc/MHrNcvMr/file-000000002c906243b1fb58ce1bd6d82d-1.png"
             alt="Logo" class="w-full h-full object-cover">
      </div>
      <h1 class="font-['Pacifico'] text-2xl text-primary">L'ap√©ro catalan¬Æ</h1>
    </div>
  </div>
</header>

<main class="pt-[220px] pb-[80px] px-4 flex flex-col gap-6">
  <!-- ‚úÖ 1/4 bouton principal (APPELER) => d√©clenche l'age gate -->
  <a href="tel:0652336461"
     id="callBtn"
     class="w-full py-4 bg-primary text-white font-semibold !rounded-button flex items-center justify-center gap-2 cursor-pointer hover:opacity-90 transition-opacity">
    <div class="w-6 h-6 flex items-center justify-center">
      <i class="ri-phone-fill text-xl"></i>
    </div>
    <span>APPELER</span>
  </a>
  <!-- ‚úÖ 3/4 bouton principal (ZONE) => d√©clenche l'age gate -->
  <button id="zoneBtn"
          class="w-full py-4 bg-secondary text-white font-semibold !rounded-button flex items-center justify-center gap-2 cursor-pointer hover:opacity-90 transition-opacity">
    <div class="w-6 h-6 flex items-center justify-center">
      <i class="ri-map-pin-2-fill text-xl"></i>
    </div>
    <span>ZONE DE LIVRAISON</span>
  </button>

  <!-- ‚úÖ 4/4 bouton principal (ARTICLES) => d√©clenche l'age gate -->
  <button id="articlesBtn"
          class="w-full py-4 bg-primary text-white font-semibold !rounded-button flex items-center justify-center gap-2 cursor-pointer hover:opacity-90 transition-opacity">
    <div class="w-6 h-6 flex items-center justify-center">
      <i class="ri-shopping-bag-fill text-xl"></i>
    </div>
    <span>NOS ARTICLES</span>
  </button>


  <!-- ‚úÖ 2/4 bouton principal (INSTALL) => d√©clenche l'age gate -->
  <button id="installBtn"
          class="w-full bg-[#FFC107] text-white py-4 !rounded-button font-semibold flex items-center justify-center gap-2 shadow-lg hover:opacity-95 transition hidden mt-4">
    <i class="ri-download-cloud-2-line text-xl"></i>
    AJOUTER √Ä L'√âCRAN D'ACCUEIL
  </button>
  <p id="installHint" class="text-xs text-white/90 text-center hidden mt-2">
    Sur iPhone : appuie sur <b>Partager</b> puis <b>Sur l‚Äô√©cran d‚Äôaccueil</b>.
  </p>

  <div class="mt-6 p-4 bg-white/90 !rounded-button shadow-sm">
    <h3 class="text-lg font-semibold text-primary mb-3">Horaires & Zone de Livraison</h3>
    <ul class="space-y-2 text-sm">
      <li class="flex items-center gap-2">
        <i class="ri-time-line text-primary"></i>
        <span>Livraison 7j/7 de 19h √† 6h</span>
      </li>
      <li class="flex items-center gap-2">
        <i class="ri-map-pin-range-line text-primary"></i>
        <span>Jusqu'√† 30km de Perpignan</span>
      </li>
      <li class="flex items-center gap-2">
        <i class="ri-phone-line text-primary"></i>
        <span>Service rapide et professionnel</span>
      </li>
      <li class="flex items-center gap-2">
        <i class="ri-bank-card-line text-primary"></i>
        <span>Paiement en esp√®ces ou carte bancaire au v√©hicule</span>
      </li>
    </ul>
    <!-- ‚úÖ Badge Google Play (site uniquement, jamais dans la PWA/app) -->
    <div id="playBadgeWrap" class="mt-6 flex items-center justify-center">
      <a id="playBadgeBtn" href="https://play.google.com/store/apps/details?id=net.aperos.catalan" target="_blank" rel="noopener"
         class="playstore-badge playstore-pulse !rounded-button px-6 py-3 bg-white text-gray-700 font-semibold flex items-center justify-center gap-3 shadow-md border border-black/5 select-none"
         aria-label="Ouvrir Google Play">
        <span class="playstore-triangle" aria-hidden="true"></span>
        <span>Google Play</span>
      </a>
    </div>

</div>
  </div>
</main>

<footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100">
  <div class="w-full max-w-[430px] mx-auto py-4 px-4 flex items-center justify-center gap-6">
    <button id="cgvBtn" class="text-xs text-gray-500 hover:text-primary cursor-pointer">CGV</button>
    <button id="mentionsBtn" class="text-xs text-gray-500 hover:text-primary cursor-pointer">Mentions l√©gales</button>
  </div>
</footer>

<!-- ===== MODALS ===== -->
<div id="zoneModal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="w-[340px] bg-white !rounded-button p-4 relative">
    <button class="absolute right-4 top-4 w-6 h-6 flex items-center justify-center text-gray-500 hover:text-primary"
            onclick="closeModal('zoneModal')">
      <i class="ri-close-line text-xl"></i>
    </button>
    <h2 class="text-xl font-semibold mb-4">Zone de livraison</h2>
    <div class="h-[400px] bg-gray-100 !rounded-button overflow-hidden">
      <!--
PATH: /livraison_map.html
FILE: livraison_map.html
-->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Zone de livraison ‚Äî Communes</title>

  <!-- ‚úÖ SEO l√©ger (z√©ro impact visuel) -->
  <meta name="description" content="Carte des communes livr√©es : tarifs et d√©lais estim√©s. Zone de livraison d‚Äôalcool dans le 66 (Pyr√©n√©es-Orientales)." />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <link rel="canonical" href="./livraison_map.html" />
  <meta property="og:title" content="Zone de livraison ‚Äî Communes" />
  <meta property="og:description" content="Carte des communes livr√©es : tarifs et d√©lais estim√©s. Zone de livraison d‚Äôalcool dans le 66." />
  <meta property="og:type" content="website" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0f0a0b;
      --text:#111827;
      --muted:#6b7280;
      --primary:#8a0b0b;
      --primary2:#b10f0f;
      --shadow: 0 10px 25px rgba(0,0,0,.18);
      --ring: rgba(138,11,11,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{min-height:100%; display:flex; justify-content:center; padding:12px;}
    .panel{
      width:min(980px, 100%);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    header{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    header h1{margin:0; font-size:16px; color:var(--text); letter-spacing:.2px;}
    header .sub{margin:2px 0 0; font-size:12px; color:var(--muted);}
    .hdr-left{display:flex; flex-direction:column; min-width:0;}
    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      font-weight:800;color:#fff;
      background: linear-gradient(180deg, var(--primary2), var(--primary));
      box-shadow: 0 10px 18px rgba(138,11,11,.22);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}

    .content{display:flex; flex-direction:column; min-height:0; flex:1;}
    #map{height:62vh; min-height:360px; width:100%;}

    .filters{
      background:rgba(255,255,255,.92);
      border-top:1px solid rgba(0,0,0,.06);
      padding:12px 14px;
    }
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      max-width: 860px;
      margin: 0 auto;
    }
    .card h2{margin:0 0 8px; font-size:14px; color:var(--text)}
    .card p{margin:0; font-size:12.8px; color:var(--muted); line-height:1.45}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 720px){
      .grid{grid-template-columns:1fr;}
      #map{height:56vh;}
    }

    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted); font-weight:800;}
    select, input{
      border-radius:12px;
      border:1px solid rgba(17,24,39,.12);
      padding:11px 10px;
      font-size:14px;
      outline:none;
    }
    select:focus, input:focus{
      border-color: rgba(138,11,11,.35);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .muted{color:var(--muted)}
    .count{margin-top:10px; font-size:12.6px; color:var(--muted); font-weight:700;}
    .attr{margin-top:8px; font-size:11.8px; color:rgba(107,114,128,.95);}

    /* Pastille num√©rot√©e */
    .num-marker{
      width:34px;
      height:34px;
      border-radius:999px;
      background: var(--primary);
      border:2px solid rgba(255,255,255,.95);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      display:grid;
      place-items:center;
      color:#fff;
      font-weight:900;
      font-size:14px;
      line-height:1;
    }

    /* ‚úÖ cache l‚Äôattribution Leaflet/OSM dans la carte */
    .leaflet-control-attribution{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <header>
        <div class="hdr-left">
          <h1>Zone de livraison ‚Äî Communes</h1>
          <div class="sub">Clique sur un num√©ro pour voir tarif + d√©lai</div>
        </div>
        <a class="btn" href="./">‚Üê Retour</a>
      </header>

      <div class="content">
        <div id="map" aria-label="Carte des communes livr√©es"></div>

        <!-- ‚úÖ UNIQUEMENT LES 2 FILTRES DEMAND√âS -->
        <div class="filters">
          <div class="card">
            <h2>Rechercher / Aller √†</h2>
            <p>Choisis une commune ou tape son nom.</p>

            <div class="grid">
              <div class="field">
                <label for="communeSelect">Liste des communes (A‚ÜíZ)</label>
                <select id="communeSelect"></select>
              </div>
              <div class="field">
                <label for="searchInput">Recherche par nom</label>
                <input id="searchInput" type="text" placeholder="Tape un nom de commune‚Ä¶" autocomplete="off" />
              </div>
            </div>

            <div class="count" id="countInfo"></div>

            <!-- ‚úÖ Attribution l√©gale (VISIBLE) mais plus de bandeau noir -->
            <div class="attr">Donn√©es carto ¬© OpenStreetMap contributors ‚Ä¢ Affichage Leaflet</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========
    // CONFIG
    // =========
    const CENTER = [42.6887, 2.8948]; // Perpignan approx
    const DEFAULT_ZOOM = 10;

    // Nominatim (OSM) - geocoding + cache
    const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search";
    const GEO_CACHE_KEY = "adn66_geo_cache_v1";
    const GEO_RATE_MS = 1100;

    // =========
    // DATA (MISE √Ä JOUR AVEC TES INFOS)
    // =========
    // REMOVALS (tu n'y vas pas) : Ille-sur-T√™t, Montesquieu-des-Alb√®res
    const COMMUNES = [
      // A
      { name: "Al√©nya", cp: "66200", price: "9 ‚Ç¨",  delay: "20 √† 25 min" },
      { name: "Argel√®s-sur-Mer", cp: "66700", price: "16 ‚Ç¨", delay: "30 √† 35 min" },

      // B
      { name: "Bages", cp: "66670", price: "8 ‚Ç¨",  delay: "20 √† 25 min" },
      { name: "Baho", cp: "66540", price: "8 ‚Ç¨",  delay: "20 √† 25 min" },
      { name: "Baixas", cp: "66390", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Le Barcar√®s", cp: "66420", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Bompas", cp: "66430", price: "7 ‚Ç¨",  delay: "15 √† 20 min" },

      // C
      { name: "Cabestany", cp: "66330", price: "4 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Canet-en-Roussillon", cp: "66140", price: "6 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Canoh√®s", cp: "66680", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Claira", cp: "66530", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Collioure", cp: "66190", price: "20 ‚Ç¨", delay: "25 √† 35 min" },
      { name: "Corneilla-del-Vercol", cp: "66200", price: "11 ‚Ç¨", delay: "25 √† 30 min" },
      { name: "Corneilla-la-Rivi√®re", cp: "66550", price: "9 ‚Ç¨", delay: "20 √† 25 min" },

      // E
      { name: "Elne", cp: "66200", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Espira-de-l‚ÄôAgly", cp: "66600", price: "9 ‚Ç¨", delay: "20 √† 25 min" },

      // F
      { name: "Fitou", cp: "11510", price: "11 ‚Ç¨", delay: "25 √† 30 min" },

      // L
      { name: "Latour-Bas-Elne", cp: "66200", price: "9 ‚Ç¨", delay: "25 √† 35 min" },
      { name: "Le Soler", cp: "66270", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Leucate", cp: "11370", price: "16 ‚Ç¨", delay: "25 √† 35 min" },

      // M
      { name: "Millas", cp: "66170", price: "9 ‚Ç¨", delay: "25 √† 30 min" },
      { name: "Montescot", cp: "66200", price: "9 ‚Ç¨", delay: "20 √† 30 min" },

      // N
      { name: "N√©fiach", cp: "66170", price: "9 ‚Ç¨", delay: "25 √† 30 min" },
      { name: "Nyls", cp: "66300", price: "11 ‚Ç¨", delay: "25 √† 30 min" },

      // P
      { name: "Perpignan", cp: "66000", price: "4 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Peyrestortes", cp: "66600", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Pia", cp: "66380", price: "4 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Pollestres", cp: "66450", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Ponteilla", cp: "66300", price: "9 ‚Ç¨", delay: "20 √† 30 min" },
      { name: "P√©zilla-la-Rivi√®re", cp: "66370", price: "9 ‚Ç¨", delay: "20 √† 25 min" },

      // R
      { name: "Rivesaltes", cp: "66600", price: "9 ‚Ç¨", delay: "20 √† 25 min" },

      // S
      { name: "Saleilles", cp: "66280", price: "7 ‚Ç¨", delay: "15 √† 25 min" },
      { name: "Salses-le-Ch√¢teau", cp: "66600", price: "11 ‚Ç¨", delay: "25 √† 35 min" },
      { name: "Saint-Cyprien", cp: "66750", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Saint-Cyprien Plage", cp: "66750", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Saint-Est√®ve", cp: "66240", price: "8 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Saint-F√©liu-d‚ÄôAmont", cp: "66170", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Saint-F√©liu-d‚ÄôAvall", cp: "66170", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Saint-Hippolyte", cp: "66510", price: "6 ‚Ç¨", delay: "15 √† 25 min" },
      { name: "Saint-Laurent-de-la-Salanque", cp: "66250", price: "7 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Saint-Nazaire", cp: "66570", price: "6 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Sainte-Marie-la-Mer", cp: "66470", price: "6 ‚Ç¨", delay: "15 √† 20 min" },

      // T
      { name: "Th√©za", cp: "66200", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Thuir", cp: "66300", price: "9 ‚Ç¨", delay: "20 √† 30 min" },
      { name: "Torreilles", cp: "66440", price: "6 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Toulouges", cp: "66350", price: "8 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Trouillas", cp: "66300", price: "9 ‚Ç¨", delay: "20 √† 30 min" },

      // V
      { name: "Villelongue-de-la-Salanque", cp: "66410", price: "4 ‚Ç¨", delay: "15 √† 20 min" },
      { name: "Villeneuve-de-la-Raho", cp: "66180", price: "9 ‚Ç¨", delay: "20 √† 25 min" },
      { name: "Villemolaque", cp: "66300", price: "9 ‚Ç¨", delay: "20 √† 30 min" }
    ];

    // =========
    // STATE
    // =========
    let map;
    let markersByKey = new Map();
    let sorted = [];
    let geoCache = loadGeoCache();
    let geoQueueRunning = false;

    // =========
    // INIT
    // =========
    window.addEventListener("load", async () => {
      sorted = normalizeAndSort(COMMUNES);

      // ‚úÖ plus de barre noire d‚Äôattribution dans la carte
      map = L.map("map", { scrollWheelZoom: true, attributionControl: false }).setView(CENTER, DEFAULT_ZOOM);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: ""
      }).addTo(map);

      buildSelect(sorted);
      bindUI();

      applyCachedCoords(sorted);
      buildOrUpdateMarkers(sorted);
      fitToAll();

      await geocodeMissingSequential(sorted);

      updateCountInfo();
    });

    // =========
    // MARKERS
    // =========
    function buildOrUpdateMarkers(list){
      list.forEach((c, idx) => {
        const key = makeKey(c);
        const n = idx + 1;

        if (!isValidLatLng(c.lat, c.lng)) return;

        const icon = L.divIcon({
          className: "",
          html: `<div class="num-marker">${n}</div>`,
          iconSize: [34, 34],
          iconAnchor: [17, 17],
          popupAnchor: [0, -14]
        });

        const popupHtml = popupFor(c);
        const existing = markersByKey.get(key);

        if (existing) {
          existing.setLatLng([c.lat, c.lng]);
          existing.setIcon(icon);
          existing.setPopupContent(popupHtml);
        } else {
          const marker = L.marker([c.lat, c.lng], { icon })
            .addTo(map)
            .bindPopup(popupHtml, { maxWidth: 300 });
          markersByKey.set(key, marker);
        }
      });
    }

    function popupFor(c){
      const name = escapeHtml(c.name);
      const cp = escapeHtml(c.cp);
      const delay = escapeHtml((c.delay && c.delay.trim()) ? c.delay : "‚Äî");
      const price = escapeHtml((c.price && c.price.trim()) ? c.price : "‚Äî");
      return `
        <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; line-height:1.25;">
          <div style="font-weight:900; font-size:14px; margin-bottom:6px;">${name} (${cp})</div>
          <div style="margin-bottom:4px;">‚è±Ô∏è <strong>D√©lai estim√© :</strong> ${delay}</div>
          <div style="margin-bottom:4px;">üöö <strong>Tarif livraison :</strong> ${price}</div>
          <div style="color:#6b7280; font-size:12px; margin-top:6px;">D√©lai indicatif selon trafic/charge.</div>
        </div>
      `;
    }

    // =========
    // UI
    // =========
    function buildSelect(list){
      const sel = document.getElementById("communeSelect");
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "‚Äî Choisir une commune ‚Äî";
      sel.appendChild(opt0);

      list.forEach((c) => {
        const o = document.createElement("option");
        o.value = makeKey(c);
        const p = (c.price && c.price.trim()) ? c.price : "‚Äî";
        const d = (c.delay && c.delay.trim()) ? c.delay : "‚Äî";
        o.textContent = `${c.name} (${c.cp}) ‚Äî ${p} ‚Ä¢ ${d}`;
        sel.appendChild(o);
      });
    }

    function bindUI(){
      const sel = document.getElementById("communeSelect");
      const input = document.getElementById("searchInput");

      sel.addEventListener("change", () => {
        const key = sel.value;
        if (!key) return;
        focusCommuneByKey(key, true);
      });

      input.addEventListener("input", () => {
        applySearchFilter();
      });
    }

    function applySearchFilter(){
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      let filtered = sorted;

      if (q) {
        filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || String(c.cp).includes(q));
      }

      buildSelect(filtered);
      updateCountInfo(filtered.length);

      if (filtered.length === 1) {
        const key = makeKey(filtered[0]);
        document.getElementById("communeSelect").value = key;
        focusCommuneByKey(key, true);
      }
    }

    function updateCountInfo(shown){
      const el = document.getElementById("countInfo");
      const total = sorted.length;
      const n = (typeof shown === "number") ? shown : total;
      el.textContent = `${n} commune(s) dans la liste ‚Ä¢ Total: ${total}`;
    }

    function focusCommuneByKey(key, openPopup){
      const item = sorted.find(c => makeKey(c) === key);
      if (!item) return;

      if (!isValidLatLng(item.lat, item.lng)) {
        geocodeOne(item).then(ok => {
          if (!ok) return;
          buildOrUpdateMarkers(sorted);
          map.setView([item.lat, item.lng], Math.max(map.getZoom(), 12), { animate: true });
          const marker = markersByKey.get(key);
          if (marker && openPopup) marker.openPopup();
        });
        return;
      }

      map.setView([item.lat, item.lng], Math.max(map.getZoom(), 12), { animate: true });
      const marker = markersByKey.get(key);
      if (marker && openPopup) marker.openPopup();
    }

    function fitToAll(){
      const latlngs = [];
      for (const c of sorted) {
        if (isValidLatLng(c.lat, c.lng)) latlngs.push([c.lat, c.lng]);
      }
      if (!latlngs.length) return;
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds.pad(0.12));
    }

    // =========
    // GEO (Nominatim + Cache)
    // =========
    function loadGeoCache(){
      try{
        const raw = localStorage.getItem(GEO_CACHE_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){
        return {};
      }
    }
    function saveGeoCache(){
      try{ localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache || {})); }catch(e){}
    }

    function applyCachedCoords(list){
      list.forEach(c => {
        const key = makeKey(c);
        const cached = geoCache[key];
        if (cached && isValidLatLng(cached.lat, cached.lng)) {
          c.lat = cached.lat;
          c.lng = cached.lng;
        }
      });
    }

    async function geocodeMissingSequential(list){
      if (geoQueueRunning) return;
      geoQueueRunning = true;
      try{
        for (const c of list) {
          if (isValidLatLng(c.lat, c.lng)) continue;
          await geocodeOne(c);
          buildOrUpdateMarkers(list);
          saveGeoCache();
          await sleep(GEO_RATE_MS);
        }
      } finally {
        geoQueueRunning = false;
      }
    }

    async function geocodeOne(c){
      const key = makeKey(c);
      if (geoCache[key] && isValidLatLng(geoCache[key].lat, geoCache[key].lng)) {
        c.lat = geoCache[key].lat;
        c.lng = geoCache[key].lng;
        return true;
      }

      const q = `${c.name} ${c.cp} France`;
      const url = new URL(NOMINATIM_URL);
      url.searchParams.set("format", "jsonv2");
      url.searchParams.set("limit", "1");
      url.searchParams.set("q", q);
      url.searchParams.set("countrycodes", "fr");

      try{
        const res = await fetch(url.toString(), { method:"GET", headers:{ "Accept":"application/json" }});
        if (!res.ok) return false;
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) return false;

        const lat = Number(data[0].lat);
        const lng = Number(data[0].lon);
        if (!isValidLatLng(lat, lng)) return false;

        c.lat = lat;
        c.lng = lng;
        geoCache[key] = { lat, lng, ts: Date.now() };
        saveGeoCache();
        return true;
      }catch(e){
        return false;
      }
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    // =========
    // HELPERS
    // =========
    function normalizeAndSort(list){
      const cleaned = (Array.isArray(list) ? list : [])
        .map(x => ({
          name: String(x.name || "").trim(),
          cp: String(x.cp || "").trim(),
          lat: (x.lat === undefined || x.lat === null || x.lat === "") ? undefined : (typeof x.lat === "number" ? x.lat : Number(x.lat)),
          lng: (x.lng === undefined || x.lng === null || x.lng === "") ? undefined : (typeof x.lng === "number" ? x.lng : Number(x.lng)),
          delay: String(x.delay || "‚Äî").trim(),
          price: String(x.price || "‚Äî").trim()
        }))
        .filter(x => x.name && x.cp);

      cleaned.sort((a,b) => a.name.localeCompare(b.name, "fr", { sensitivity: "base" }));
      return cleaned;
    }

    function makeKey(c){ return `${slug(c.name)}|${String(c.cp).trim()}`; }

    function slug(s){
      return String(s || "")
        .trim()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function isValidLatLng(lat, lng){
      return Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>
</body>
</html>

    </div>
  </div>
</div>

<div id="articlesModal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="w-[92vw] max-w-[430px] bg-white !rounded-button p-4 relative max-h-[90vh] overflow-y-auto">
    <button class="absolute right-4 top-4 w-6 h-6 flex items-center justify-center text-gray-500 hover:text-primary"
            onclick="closeModal('articlesModal')">
      <i class="ri-close-line text-xl"></i>
    </button>

    <div class="pr-8">
      <h2 class="text-xl font-semibold mb-1">Nos Articles</h2>


<div class="liveBanner" id="stockBanner">
  <div class="liveLeft">
    <span class="liveDot" id="stockDot"></span>
    <div>
      <div class="liveTitle" id="stockTitle">STOCK</div>
      <div class="liveSub" id="stockSub">‚Äî</div>
    </div>
  </div>
  <span class="liveChip" id="stockChip">INFO</span>
</div>


      <p class="text-xs text-gray-500 mb-3">Appelez pour commander.</p>
    </div>
    <div class="grid grid-cols-1 gap-2 mb-4">
      <div class="relative">
        <div class="w-6 h-6 absolute left-3 top-1/2 -translate-y-1/2 flex items-center justify-center text-gray-400">
          <i class="ri-search-line"></i>
        </div>
        <input type="text" id="searchInput" placeholder="Rechercher un produit..."
               class="w-full pl-10 pr-4 py-2 !rounded-button border border-gray-200 text-sm focus:outline-none focus:border-primary">
      </div>

      <div class="flex gap-2">
        <select id="sortSelect" style="display:none"
                class="w-full py-2 px-3 !rounded-button border border-gray-200 text-sm focus:outline-none focus:border-primary">
          <option value="popular">Tri : Recommand√©s</option>
          <option value="priceAsc">Tri : Prix ‚Üë</option>
          <option value="priceDesc">Tri : Prix ‚Üì</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto -mx-4 px-4 mb-3">
      <div class="flex gap-2 whitespace-nowrap pb-2" id="categoryTabs">
        <button class="px-3 py-1 text-sm !rounded-full tab-active" data-category="all">Tout</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="snacks">üç™ Ap√©ro & Bonbons</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="vodka">üç∏ Vodka</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="whisky">ü•É Whisky</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="rhum">üè¥‚Äç‚ò†Ô∏è Rhum</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="liqueurs">üçπ Liqueurs</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="gin">üåø Gin</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="tequila">üåµ Tequila</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="softs">ü•§ Softs</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="pastis">üü° Pastis</button>
<button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="vin">üç∑ Vin</button>
        <button class="px-3 py-1 text-sm !rounded-full tab-idle hover:bg-gray-200" data-category="accessoires">üßä Accessoires</button>
      </div>
    </div>

    <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
      <div id="resultInfo">‚Äî</div>
      <div class="text-gray-400">Commande : <span class="text-primary font-semibold">t√©l√©phone</span></div>
    </div>

    <div id="productGrid" class="grid grid-cols-2 gap-3"></div>

    <div class="mt-4 text-[11px] text-gray-500 leading-snug">
      Prix indicatifs ‚Ä¢ Le stock peut varier selon la nuit ‚Ä¢ Appelle pour confirmation et commande.
    </div>
  </div>
</div>

<div id="cgvModal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="w-[92vw] max-w-[430px] bg-white !rounded-button p-4 relative max-h-[90vh] overflow-y-auto">
    <button class="absolute right-4 top-4 w-6 h-6 flex items-center justify-center text-gray-500 hover:text-primary"
            onclick="closeModal('cgvModal')">
      <i class="ri-close-line text-xl"></i>
    </button>
    <h2 class="text-xl font-semibold mb-4 bg-gradient-to-r from-primary to-secondary text-transparent bg-clip-text">
      Conditions G√©n√©rales de Vente
    </h2>
    <div class="prose text-sm space-y-4">
<h3 class="font-medium">1. Service</h3>
  <p>L‚ÄôAp√©ro Catalan¬Æ propose un service de livraison de boissons et produits d‚Äôap√©ro, disponible de 19h √† 6h, 7 jours sur 7, dans la limite de la zone indiqu√©e sur le site.</p>

  <h3 class="font-medium">2. Commande</h3>
  <p>La commande se fait par t√©l√©phone. Les prix affich√©s sont indicatifs et peuvent varier selon la nuit et les disponibilit√©s. Le d√©lai estim√© est communiqu√© lors de l‚Äôappel.</p>

  <h3 class="font-medium">3. Livraison ‚Ä¢ pr√©sence obligatoire</h3>
  <p><b>Le client doit imp√©rativement √™tre pr√©sent</b> √† l‚Äôadresse convenue √† l‚Äôheure de livraison.</p>
  <p>Il appartient au client de :<br>
  - s‚Äôassurer de sa pr√©sence,<br>
  - v√©rifier l‚Äôexactitude de l‚Äôadresse (digicode, portail, interphone),<br>
  - rester joignable par t√©l√©phone.</p>
  <p>En cas d‚Äôabsence, d‚Äôadresse incorrecte ou d‚Äôacc√®s impossible, la livraison pourra √™tre annul√©e sans d√©dommagement. Le livreur poursuivra sa tourn√©e apr√®s un d√©lai d‚Äôattente raisonnable.</p>

  <h3 class="font-medium">4. Remise au v√©hicule ‚Ä¢ s√©curit√©</h3>
  <p>Pour des raisons de s√©curit√© des personnes et de la marchandise, le livreur ne sort pas de son v√©hicule. La remise de la commande s‚Äôeffectue <b>au v√©hicule</b>, √† proximit√© imm√©diate du domicile.</p>

  <h3 class="font-medium">5. Paiement</h3>
  <p>Paiement √† la livraison : <b>esp√®ces</b> ou <b>carte bancaire</b> au v√©hicule (terminal s√©curis√©).</p>
  <p>Le paiement en esp√®ces peut √™tre refus√© si :<br>
  - plus de 50 pi√®ces sont utilis√©es,<br>
  - le client n‚Äôa pas l‚Äôappoint et le livreur ne peut pas rendre la monnaie,<br>
  - les billets/pi√®ces paraissent suspects, tr√®s endommag√©s ou retir√©s de la circulation.</p>

  <h3 class="font-medium">6. Alcool ‚Ä¢ protection des mineurs</h3>
  <p>Conform√©ment √† la loi, la vente d‚Äôalcool est interdite aux mineurs. Une pi√®ce d‚Äôidentit√© pourra √™tre demand√©e. En cas de doute ou de refus, la livraison sera annul√©e.</p>

  <h3 class="font-medium">7. Responsabilit√©</h3>
  <p>Nous ne sommes pas responsables des retards ou annulations dus √† des informations incorrectes, √† l‚Äôabsence du client ou √† un acc√®s impossible. En cas de force majeure (intemp√©ries, accidents, etc.), nous pouvons retarder ou annuler une livraison.</p>

  <h3 class="font-medium">8. Donn√©es personnelles (RGPD)</h3>
  <p>Nous collectons uniquement les informations n√©cessaires √† la livraison (adresse et t√©l√©phone) et, si applicable, √† la communication commerciale par SMS. Ces donn√©es sont conserv√©es au maximum 3 ans et ne sont pas utilis√©es √† d‚Äôautres fins. Aucun cookie de suivi n‚Äôest utilis√© sur ce mini-site.</p>

  <h3 class="font-medium">9. Modifications</h3>
  <p>Nous pouvons modifier les pr√©sentes conditions √† tout moment. La version applicable est celle en vigueur au moment de la commande.</p>
    </div>
  </div>
</div>

<div id="mentionsModal" class="modal fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="w-[92vw] max-w-[430px] bg-white !rounded-button p-4 relative max-h-[90vh] overflow-y-auto">
    <button class="absolute right-4 top-4 w-6 h-6 flex items-center justify-center text-gray-500 hover:text-primary"
            onclick="closeModal('mentionsModal')">
      <i class="ri-close-line text-xl"></i>
    </button>
    <h2 class="text-xl font-semibold mb-4 bg-gradient-to-r from-primary to-secondary text-transparent bg-clip-text">
  Mentions L√©gales
</h2>

<div class="prose text-sm space-y-4">
  <h3 class="font-medium text-base">√âditeur du site</h3>
  <p>
    Le pr√©sent site internet <strong>¬´ L‚ÄôAp√©ro Catalan¬Æ ¬ª</strong> est exploit√© par la soci√©t√©
    <strong>Ap√©ro de Nuit 66¬Æ</strong>, entreprise immatricul√©e au Registre du Commerce et des Soci√©t√©s sous le num√©ro
    <strong>953 976 099 00010</strong>, dont le si√®ge social est situ√© √† <strong>Villelongue-de-la-Salanque</strong>.
  </p>

  <h3 class="font-medium text-base">Responsable de publication</h3>
  <p>
    <strong>Monsieur Hauviller Steven</strong>, en qualit√© de repr√©sentant l√©gal de l‚Äôentreprise
    <strong>Ap√©ro de Nuit 66¬Æ</strong>.
  </p>

  <h3 class="font-medium text-base">Propri√©t√© intellectuelle / Marque</h3>
  <p>
    <strong>¬´ L‚ÄôAp√©ro Catalan¬Æ ¬ª</strong> est une marque exploit√©e par <strong>Ap√©ro de Nuit 66¬Æ</strong>.
    <br>
    Enregistrement officiel INPI :
    <a href="https://data.inpi.fr/marques/FR5210305" target="_blank" rel="noopener noreferrer">FR5210305</a>.
  </p>

  <h3 class="font-medium text-base">Donn√©es personnelles & RGPD</h3>
  <p>
    Nous ne collectons pas de donn√©es personnelles via ce mini-site (pas de compte, pas de formulaire, pas de suivi).
  </p>
  <p>
    Si vous choisissez d‚Äôactiver les notifications push, l‚Äôabonnement est g√©r√© par votre navigateur/appareil.
    Vous pouvez vous d√©sabonner √† tout moment depuis les r√©glages de votre navigateur.
  </p>
  <p>
    Pour plus d‚Äôinformations, consultez notre
    <a href="./privacy.html">politique de confidentialit√©</a>.
  </p>

  <h3 class="font-medium text-base">Alcool / Vente interdite aux mineurs</h3>
  <p>
    L‚Äôabus d‚Äôalcool est dangereux pour la sant√©. √Ä consommer avec mod√©ration.
    <br>
    <strong>Il est interdit de vendre de l‚Äôalcool √† des mineurs.</strong>
    Un contr√¥le de l‚Äô√¢ge peut √™tre effectu√© au moment de la livraison.
  </p>
</div>

  </div>
</div>

<!-- üîû AGE GATE OVERLAYS -->
<div class="ageOverlay" id="ageQuestion" role="dialog" aria-modal="true">
  <div class="ageCard">
    <div class="ageTop">
      <div class="ageBrand">
        <div class="ageBadge">18+</div>
        <b>L'AP√âRO CATALAN¬Æ</b>
      </div>
    </div>

    <div class="ageBody">
      <div class="ageTitle">Bienvenue ‚ú®</div>
      <p class="ageLead">
        Ce site pr√©sente des boissons alcoolis√©es. Pour continuer, confirme que tu as l‚Äô√¢ge l√©gal.
      </p>

      <div class="ageNotice">
        <b>La vente d‚Äôalcool est interdite aux mineurs.</b><br>
        L‚Äôabus d‚Äôalcool est dangereux pour la sant√©, √† consommer avec mod√©ration.
      </div>

      <div class="ageBtns">
        <button class="ageBtn ageBtnPrimary" id="ageYes">‚úÖ Je suis majeur</button>
        <button class="ageBtn ageBtnSecondary" id="ageNo">‚ÑπÔ∏è Je ne suis pas majeur</button>
      </div>

      <div class="ageFine">üîí Choix m√©moris√© sur cet appareil.</div>
    </div>
  </div>
</div>

<div class="ageOverlay" id="ageBlocked" role="dialog" aria-modal="true">
  <div class="ageCard">
    <div class="ageTop">
      <div class="ageBrand">
        <div class="ageBadge">NO</div>
        <b>ACC√àS R√âSERV√â</b>
      </div>
    </div>

    <div class="ageBody">
      <div class="ageTitle">Acc√®s r√©serv√© üîû</div>
      <p class="ageLead">
        Ce contenu est strictement r√©serv√© aux personnes majeures.<br>
        La vente d‚Äôalcool est interdite aux mineurs.
      </p>

      <div class="ageNotice">
        Pour acc√©der au contenu, une v√©rification d‚Äô√¢ge est obligatoire.
      </div>

      <!-- (compteur cach√© : on ne montre pas la dur√©e de blocage) -->
      <div class="ageTimer" style="display:none;">
        <span id="ageCount">48:00:00</span>
      </div>

      <div class="ageFine">
        Si tu penses √™tre bloqu√© par erreur, contacte Ap√©ro de Nuit¬Æ (06.52.33.64.61)
        ou <a href="mailto:contact@aperos.net">contact@aperos.net</a>.
      </div>
      <div class="ageFine" style="margin-top:10px;">
        L‚Äôabus d‚Äôalcool est dangereux pour la sant√©.
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // =========================
  // üü•üü®‚¨õ BANNI√àRE STOCK (alcool)
  // - 3 √©tats : LIVE / PR√âPARATION / HORS LIGNE
  // - Horaires al√©atoires (par jour) :
  //   PR√âPA d√©marre entre 18:28‚Äì18:35 (jusqu'au LIVE)
  //   LIVE d√©marre entre 18:50‚Äì19:30
  //   LIVE finit entre 05:10‚Äì05:55
  // =========================
  const BANNER = {
    LS_PREFIX: "ac_banner_sched_",
    PREP_START: { h1:18, m1:28, h2:18, m2:35 },
    LIVE_START: { h1:18, m1:50, h2:19, m2:30 },
    LIVE_END:   { h1:5,  m1:10, h2:5,  m2:55 }
  };

  function pad2(n){ return String(n).padStart(2,"0"); }
  function ymd(d){ return d.getFullYear()+pad2(d.getMonth()+1)+pad2(d.getDate()); }

  // La "journ√©e service" : si on est le matin (avant midi), on se rattache √† la veille (fin de service)
  function serviceDayKey(now){
    const d = new Date(now);
    if(d.getHours() < 12){
      d.setDate(d.getDate()-1);
    }
    return ymd(d);
  }

  function minutesBetween(aH,aM,bH,bM){
    return (bH*60+bM) - (aH*60+aM);
  }
  function randInt(min, max){
    // inclusif
    return Math.floor(Math.random()*(max-min+1))+min;
  }
  function timeInRange(baseDate, r){
    const minM = r.h1*60 + r.m1;
    const maxM = r.h2*60 + r.m2;
    const pick = randInt(minM, maxM);
    const d = new Date(baseDate);
    d.setHours(Math.floor(pick/60), pick%60, 0, 0);
    return d.getTime();
  }

  function getOrCreateBannerSchedule(){
    const key = BANNER.LS_PREFIX + serviceDayKey(Date.now());
    try{
      const raw = localStorage.getItem(key);
      if(raw){
        const s = JSON.parse(raw);
        if(s && s.prepStart && s.liveStart && s.liveEnd) return s;
      }
    }catch{}

    // Base date = jour "service" √† 00:00 locale
    const now = new Date();
    const d = new Date();
    if(now.getHours() < 12) d.setDate(d.getDate()-1); // service = veille
    d.setHours(0,0,0,0);

    const prepStart = timeInRange(d, BANNER.PREP_START);
    const liveStart = timeInRange(d, BANNER.LIVE_START);

    // liveEnd = le lendemain matin
    const d2 = new Date(d);
    d2.setDate(d2.getDate()+1);
    const liveEnd = timeInRange(d2, BANNER.LIVE_END);

    // S√©curit√© : si par hasard liveStart < prepStart, on force l'ordre
    const safeLiveStart = Math.max(liveStart, prepStart + 60*1000);
    const sched = { prepStart, liveStart: safeLiveStart, liveEnd, key };

    try{ localStorage.setItem(key, JSON.stringify(sched)); }catch{}
    return sched;
  }

  function computeBannerState(){
    const now = Date.now();
    const s = getOrCreateBannerSchedule();
    if(now >= s.liveStart && now < s.liveEnd) return "live";
    if(now >= s.prepStart && now < s.liveStart) return "prep";
    return "offline";
  }

  function setStockBanner(){
    const el = document.getElementById("stockBanner");
    const t  = document.getElementById("stockTitle");
    const sub= document.getElementById("stockSub");
    const chip=document.getElementById("stockChip");
    if(!el||!t||!sub||!chip) return;

    const state = computeBannerState();

    el.classList.remove("prep","offline");

    if(state === "live"){
      t.textContent = "STOCK EN DIRECT";
      sub.textContent = "Stock synchronis√© avec le v√©hicule";
      chip.textContent = "LIVE";
      // √©tat par d√©faut (rouge)
    }else if(state === "prep"){
      el.classList.add("prep");
      t.textContent = "PR√âPARATION DE LA TOURN√âE";
      sub.textContent = "En ligne vers 19h";
      chip.textContent = "Bient√¥t";
    }else{
      el.classList.add("offline");
      t.textContent = "HORS LIGNE";
      sub.textContent = "Hors service ‚Ä¢ reprise ce soir";
      chip.textContent = "OFF";
    }
  }

  const modals = {
    zoneModal: document.getElementById('zoneModal'),
    articlesModal: document.getElementById('articlesModal'),
    cgvModal: document.getElementById('cgvModal'),
    mentionsModal: document.getElementById('mentionsModal')
  };
  const buttons = {
    zoneBtn: document.getElementById('zoneBtn'),
    articlesBtn: document.getElementById('articlesBtn'),
    cgvBtn: document.getElementById('cgvBtn'),
    mentionsBtn: document.getElementById('mentionsBtn')
  };

    loadStockCache();
    setStockBanner();
    setInterval(setStockBanner, 30000);


  // ‚úÖ BI√àRES RETIR√âES
  // ‚úÖ VIN : DOMAINE DU VIEUX GENEVRIER remplac√© par XV Catalan
  const products = {
"snacks": [
  {"id":"cacahuette","name":"Cacahu√®te","price":2.5},
  {"id":"bretzel","name":"Bretzel","price":2.5},
  {"id":"curly","name":"Curly","price":2.5},
  {"id":"chips","name":"Chips","price":2.5},
  {"id":"monster_munch","name":"Monster Munch","price":2.5},
  {"id":"dragibus","name":"Dragibus","price":2.5},
  {"id":"fraise_tagada","name":"Fraise Tagada","price":2.5}
],
    "vodka": [
      {"id":"poliakov","name":"Poliakov","price":29.0},
      {"id":"absolut","name":"Absolut Vodka","price":34.0},
      {"id":"ciroc_classic","name":"C√Æroc Classic","price":49.0},
      {"id":"ciroc_redberry","name":"C√Æroc Red Berry","price":49.0},
      {"id":"ciroc_pomme","name":"C√Æroc Pomme","price":49.0}
    ],
    "whisky": [
      {"id":"william_peel","name":"William Peel","price":29.0},
      {"id":"label_5","name":"Label 5","price":32.0},
      {"id":"ballantines","name":"Ballantine's","price":36.0},
      {"id":"jack_old7","name":"Jack Daniel's","price":40.0},
      {"id":"jack_honey","name":"Jack Daniel's Honey","price":42.0}
    ],
    "rhum": [
      {"id":"old_nick_darkwood","name":"Old Nick Dark Wood","price":29.0},
      {"id":"captain_morgan","name":"Captain Morgan","price":34.0},
      {"id":"havana_especial","name":"Havana Club Especial","price":38.0},
      {"id":"saint_james_blanc","name":"Saint James Rhum blanc","price":32.0},
      {"id":"trois_rivieres","name":"Trois Rivi√®res","price":33.0},
      {"id":"havana_3ans","name":"Havana Club 3 ans","price":37.0}
    ],
    "liqueurs": [
      {"id":"get_27","name":"GET 27","price":32.0},
      {"id":"jagermeister","name":"J√§germeister","price":35.0}
    ],
    "gin": [
      {"id":"gibsons_gin","name":"Gibson's Gin","price":34.0},
      {"id":"gordons_gin","name":"Gordon's Gin","price":34.0}
    ],
    "tequila": [
      {"id":"tequila_sanjose","name":"Tequila San Jos√©","price":28.0}
    ],
    "pastis": [
      {"id":"ricard","name":"Ricard","price":35.0},
      {"id":"pastis_51","name":"Pastis 51","price":35.0}
    ],
    "vin": [
      {"id":"xv_catalan_rose","name":"XV catalan ros√©","price":19.0},
      {"id":"xv_catalan_blanc","name":"XV catalan blanc","price":19.0},
      {"id":"xv_catalan_rouge","name":"XV catalan rouge","price":19.0},
      {"id":"muscat","name":"Muscat","price":25.0}
    ],
    "softs": [
      {"id":"oasis_tropical","name":"Oasis (tropical)","price":3.5},
      {"id":"schweppes_tonic","name":"Schweppes tonic","price":3.5},
      {"id":"perrier","name":"Perrier","price":2.5},
      {"id":"perrier_citron","name":"Perrier citron","price":2.5},
      {"id":"crazy_tiger","name":"Crazy Tiger","price":5.0},
      {"id":"jus_pomme","name":"Jus de pommes","price":4.5},
      {"id":"jus_orange","name":"Jus d'oranges","price":4.5},
      {"id":"jus_ananas","name":"Jus d'ananas","price":4.5}
    ],
    "accessoires": [
      {"id":"verre_whisky","name":"Verre √† whisky-soda incassable 35 cl","price":0.5}
    ]
  };

  // =========================
  // üîû AGE GATE (m√™me m√©thode)
  // D√©clench√© par les 4 boutons principaux
  // =========================
  const AGE = {
    // Majeur : on m√©morise une "validit√©" (comme sur ton autre page)
    KEY_MAJOR_UNTIL: "ad_major_until",
    KEY_LAST: "ad_last_choice",

    // Mineur : on m√©morise un blocage silencieux 48h (persistant m√™me apr√®s refresh)
    KEY_MINOR_UNTIL: "ad_minor_until",

    MAJOR_MS: 20 * 24 * 60 * 60 * 1000, // 20 jours
    MINOR_MS: 48 * 60 * 60 * 1000       // 48h
  };

  const ageQuestion = document.getElementById("ageQuestion");
  const ageBlocked  = document.getElementById("ageBlocked");
  const ageYes      = document.getElementById("ageYes");
  const ageNo       = document.getElementById("ageNo");
  const ageCount    = document.getElementById("ageCount");

  let ageInterval = null;
  let agePendingAction = null;

  function ageNow(){ return Date.now(); }

  function ageGetMajorUntil(){
    const v = localStorage.getItem(AGE.KEY_MAJOR_UNTIL);
    const n = v ? parseInt(v, 10) : 0;
    return Number.isFinite(n) ? n : 0;
  }
  function ageIsMajorValid(){ return ageGetMajorUntil() > ageNow(); }

  function ageGetMinorUntil(){
    const v = localStorage.getItem(AGE.KEY_MINOR_UNTIL);
    const n = v ? parseInt(v, 10) : 0;
    return Number.isFinite(n) ? n : 0;
  }
  function ageIsMinorBlocked(){ return ageGetMinorUntil() > ageNow(); }

  function ageShow(el){
    el.classList.add("show");
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";
  }
  function ageHide(el){
    el.classList.remove("show");
    if(!ageQuestion.classList.contains("show") && !ageBlocked.classList.contains("show")){
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }
  }
  function ageShowQuestion(){
    ageHide(ageBlocked);
    ageShow(ageQuestion);
  }

  // (Optionnel) compteur cach√© : on ne r√©v√®le pas les 48h √† l'utilisateur
  function fmtHMS(totalSeconds){
    const s = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    const pad = (x)=> String(x).padStart(2,"0");
    return `${pad(h)}:${pad(m)}:${pad(ss)}`;
  }

  function ageShowBlocked(){
    ageHide(ageQuestion);
    ageShow(ageBlocked);

    // Timer silencieux bas√© sur la vraie date de fin stock√©e
    const until = ageGetMinorUntil();
    const leftMs = Math.max(0, until - ageNow());

    // On garde le span (cach√©) √† jour si jamais tu veux l'afficher plus tard
    if (ageCount){
      ageCount.textContent = fmtHMS(Math.ceil(leftMs / 1000));
    }

    if(ageInterval) clearInterval(ageInterval);
    if(leftMs > 0){
      ageInterval = setInterval(() => {
        const l = Math.max(0, ageGetMinorUntil() - ageNow());
        if (ageCount) ageCount.textContent = fmtHMS(Math.ceil(l / 1000));
        if(l <= 0){
          clearInterval(ageInterval);
          ageInterval = null;
          localStorage.removeItem(AGE.KEY_MINOR_UNTIL); // fin du blocage
          ageShowQuestion(); // revient √† la question majeur/mineur
        }
      }, 1000);
    } else {
      // blocage expir√© (s√©curit√©)
      localStorage.removeItem(AGE.KEY_MINOR_UNTIL);
      ageShowQuestion();
    }
  }

  function ageSetMajorWeek(){
    localStorage.setItem(AGE.KEY_LAST, "major");
    localStorage.setItem(AGE.KEY_MAJOR_UNTIL, String(ageNow() + AGE.MAJOR_MS));
    localStorage.removeItem(AGE.KEY_MINOR_UNTIL); // si jamais il √©tait bloqu√© avant
  }
  function ageSetMinorBlock(){
    localStorage.setItem(AGE.KEY_LAST, "minor");
    localStorage.setItem(AGE.KEY_MINOR_UNTIL, String(ageNow() + AGE.MINOR_MS));
  }

  // Si l'utilisateur √©tait d√©j√† "mineur" => on le laisse sur la popup (persistant m√™me apr√®s refresh)
  if(ageIsMinorBlocked()){
    ageShowBlocked();
  }

  // Emp√™che ‚ÄúEscape‚Äù de fermer (m√™me logique que ta version)
  document.addEventListener("keydown", (e)=>{
    if((ageQuestion.classList.contains("show") || ageBlocked.classList.contains("show")) && e.key === "Escape"){
      e.preventDefault();
    }
  });

  function requireMajorThen(actionFn){
    // Si mineur encore bloqu√© => on reste sur la popup "acc√®s r√©serv√©"
    if(ageIsMinorBlocked()){
      agePendingAction = null;
      ageShowBlocked();
      return;
    }

    // Si majeur encore valide => on ex√©cute directement
    if(ageIsMajorValid()){
      actionFn();
      return;
    }

    // Sinon on (re)demande
    agePendingAction = actionFn;
    ageShowQuestion();
  }

  ageYes?.addEventListener("click", ()=>{
    trackHit(TRACK_AGE_ACCEPT_URL);
    ageSetMajorWeek();
    ageHide(ageQuestion);
    if(typeof agePendingAction === "function"){
      const fn = agePendingAction;
      agePendingAction = null;
      fn();
    }
  });

  ageNo?.addEventListener("click", ()=>{
    trackHit(TRACK_AGE_REFUSE_URL);
    ageSetMinorBlock();
    ageShowBlocked();
  });

  // =========================
  // MODALS (inchang√©)
  // =========================
  Object.entries(buttons).forEach(([key, btn]) => {
    const modalId = key.replace('Btn', 'Modal');
    btn.addEventListener('click', () => openModal(modalId));
  });

  window.closeModal = function(modalId) { modals[modalId].classList.remove('active'); };
  window.openModal = function(modalId) {
    modals[modalId].classList.add('active');
    if(modalId === 'articlesModal') displayProducts(getActiveCategory(), searchInput.value, sortSelect.value);
  };

  Object.values(modals).forEach(modal => {
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
  });

  const searchInput = document.getElementById('searchInput');
  const categoryTabs = document.getElementById('categoryTabs');
  const productGrid = document.getElementById('productGrid');
  const sortSelect = document.getElementById('sortSelect');
  const resultInfo = document.getElementById('resultInfo');

  const CATEGORY_ORDER = ['snacks','vodka','whisky','rhum','liqueurs','gin','tequila','pastis','vin','softs','accessoires'];

  const featuredOrder = [
  "Cacahu√®te","Bretzel","Curly","Chips","Monster Munch","Dragibus","Fraise Tagada",
    "Jack Daniel's","Ballantine's","Captain Morgan","Havana Club 3 ans","Absolut Vodka",
    "CIROC Classic","MO√ãT & CHANDON \"Imp√©rial\" (1,5 L)","Ricard","GET 27",    "XV catalan rouge","XV catalan blanc","Muscat"
  ];

  function getActiveCategory() {
    const active = categoryTabs.querySelector('.tab-active');
    return active ? active.dataset.category : 'all';
  }
  
  // =========================
  // üöö Stock v√©hicule (repo bullyto/stock)
  // - On affiche seulement Disponible / Rupture (jamais la quantit√©)
  // - Alcool = cat√©gories : vodka/whisky/rhum/liqueurs/gin/tequila/pastis/vin
  // =========================
  const STOCK_REPO = { owner:"bullyto", repo:"stock", branch:"main" };
  const STOCK_SNAPSHOT_PATH = "stock/_snapshot.json";
  const STOCK_IMG_BASE = `https://raw.githubusercontent.com/${STOCK_REPO.owner}/${STOCK_REPO.repo}/${STOCK_REPO.branch}/img/`;

  const ALCOHOL_CATS = new Set(["vodka","whisky","rhum","liqueurs","gin","tequila","pastis","vin"]);
  let stockAvail = {}; // {id: true/false}
  let stockUpdatedAt = 0;

  async function fetchStockSnapshot(){
    // cache-bust + no-store pour coller au "temps r√©el"
    const url = `https://raw.githubusercontent.com/${STOCK_REPO.owner}/${STOCK_REPO.repo}/${STOCK_REPO.branch}/${STOCK_SNAPSHOT_PATH}?t=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("snapshot_fetch_failed");
    const snap = await res.json();
    if(!snap || !Array.isArray(snap.items)) throw new Error("snapshot_bad");
    const map = {};
    snap.items.forEach(it => {
      if(!it || !it.id) return;
      const q = Number(it.qty);
      map[String(it.id)] = Number.isFinite(q) ? (q > 0) : false;
    });
    stockAvail = map;
    stockUpdatedAt = Date.now();
    try{
      localStorage.setItem("ac_stock_snapshot_cache_v1", JSON.stringify({ savedAt: stockUpdatedAt, avail: stockAvail }));
    }catch{}
  }

  function loadStockCache(){
    try{
      const raw = localStorage.getItem("ac_stock_snapshot_cache_v1");
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data && typeof data.avail === "object"){
        stockAvail = data.avail || {};
        stockUpdatedAt = Number(data.savedAt || 0) || 0;
      }
    }catch{}
  }

  function imgUrlForId(id){
    // Anticipe : images softs ajout√©es plus tard dans le d√©p√¥t stock/img/
    // Les images doivent s'appeler : <id>.png
    return `${STOCK_IMG_BASE}${encodeURIComponent(id)}.png`;
  }
function catLabel(cat){
    const map = {vodka:"Vodka",whisky:"Whisky",rhum:"Rhum",liqueurs:"Liqueurs",gin:"Gin",tequila:"Tequila",softs:"Softs",pastis:"Pastis",vin:"Vin",accessoires:"Accessoires",snacks:"Ap√©ro & Bonbons"};
    return map[cat] || cat;
  }
  function flattenProducts() {
    const out = [];
    Object.entries(products).forEach(([cat, list]) => list.forEach(p => {
      const id = p.id || "";
      const isAlcohol = ALCOHOL_CATS.has(cat);
      const available = isAlcohol ? !!stockAvail[id] : null;
      out.push({ ...p, id, category: cat, isAlcohol, available, imageUrl: id ? imgUrlForId(id) : "" });
    }));
    return out;
  }
  function getProductsForCategory(category) {
    if (category === 'all') return flattenProducts();
    return (products[category] || []).map(p => {
      const id = p.id || "";
      const isAlcohol = ALCOHOL_CATS.has(category);
      const available = isAlcohol ? !!stockAvail[id] : null;
      return ({ ...p, id, category, isAlcohol, available, imageUrl: id ? imgUrlForId(id) : "" });
    });
  }
  function applySearch(list, term) {
    const t = (term || "").trim().toLowerCase();
    if (!t) return list;
    return list.filter(p => p.name.toLowerCase().includes(t));
  }
  function applySort(list, mode) {
    const arr = [...list];
    if (mode === "az") arr.sort((a,b) => a.name.localeCompare(b.name, 'fr'));
    else if (mode === "priceAsc") arr.sort((a,b) => a.price - b.price);
    else if (mode === "priceDesc") arr.sort((a,b) => b.price - a.price);
    else {
      arr.sort((a,b) => {
        const ca = CATEGORY_ORDER.indexOf(a.category);
        const cb = CATEGORY_ORDER.indexOf(b.category);
        const rca = ca === -1 ? 9999 : ca;
        const rcb = cb === -1 ? 9999 : cb;
        if (rca !== rcb) return rca - rcb;

        // m√™me cat√©gorie : ordre "mise en avant" si pr√©sent, sinon A‚ÜíZ
        const ia = featuredOrder.indexOf(a.name), ib = featuredOrder.indexOf(b.name);
        const ra = ia === -1 ? 9999 : ia, rb = ib === -1 ? 9999 : ib;
        if (ra !== rb) return ra - rb;

        return a.name.localeCompare(b.name, 'fr');
      });
    }
    return arr;
  }

  async function displayProducts(category, searchTerm = '', sortMode = 'popular'){
    // Stock "temps r√©el" : refresh snapshot quand on est online
    if (navigator.onLine) {
      try { await fetchStockSnapshot(); } catch(e) { /* garde cache */ }
    }
const base = getProductsForCategory(category);
    const searched = applySearch(base, searchTerm);
    const sorted = applySort(searched, sortMode);

    productGrid.innerHTML = '';
    resultInfo.textContent = `${sorted.length} article${sorted.length>1?'s':''} ‚Ä¢ ${category==='all'?'Tout':catLabel(category)}`;

    sorted.forEach(product => {
      const card = document.createElement("div");
      card.className = "bg-white shadow-sm !rounded-button overflow-hidden flex flex-col border border-gray-100";
      card.innerHTML = `
        
<div class="p-3 flex-1">
          <div class="flex flex-col items-center text-center">
            <div class="w-32 h-40 rounded-2xl bg-gray-50 border border-gray-100 overflow-hidden flex items-center justify-center">
              <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-full object-contain" loading="lazy"
                onerror="this.style.display='none'; this.parentElement.classList.add('items-center');" />
            </div>

            <div class="mt-3 w-full">
              <div class="text-[10px] inline-flex items-center px-2 py-[2px] rounded-full bg-gray-100 text-gray-600 mb-2 mx-auto">
                ${catLabel(product.category)}
              </div>

              <h3 class="font-extrabold text-[15px] leading-snug text-gray-900 px-2">
                ${product.name}
              </h3>

              <p class="text-primary font-extrabold text-[18px] mt-2">
                ${product.price.toFixed(2)} <span class="text-[14px] font-black">‚Ç¨</span>
              </p>

              ${product.isAlcohol ? `
                <div class="mt-2 inline-flex items-center justify-center px-3 py-1 rounded-full text-[12px] font-extrabold ${product.available ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-rose-50 text-rose-700 border border-rose-200'}">
                  ${product.available ? 'Disponible' : 'Rupture'}
                </div>
              ` : ``}
            </div>
          </div>
        </div>

        </div>
        <div class="px-3 pb-3">
          <a href="tel:0652336461" class="w-full inline-flex items-center justify-center gap-2 py-2 bg-primary text-white text-xs font-semibold !rounded-button hover:opacity-95 transition">
            <i class="ri-phone-fill"></i> Commander
          </a>
        </div>
      `;
      productGrid.appendChild(card);
    });
  }

  categoryTabs.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
      categoryTabs.querySelectorAll('button').forEach(btn => { btn.classList.remove('tab-active'); btn.classList.add('tab-idle'); });
      e.target.classList.remove('tab-idle');
      e.target.classList.add('tab-active');
      displayProducts(e.target.dataset.category, searchInput.value, sortSelect.value);
    }
  });

  searchInput.addEventListener('input', () => displayProducts(getActiveCategory(), searchInput.value, sortSelect.value));
  sortSelect.addEventListener('change', () => displayProducts(getActiveCategory(), searchInput.value, sortSelect.value));

  displayProducts('all', '', 'popular');

  // =========================
  // ‚úÖ D√©clenche l'age gate sur les 4 boutons principaux
  // =========================
  const callBtn = document.getElementById('callBtn');

  // =========================
  // üìà TRACKING : bouton "APPELER"
  // - Envoie un hit (best-effort) AVANT l'ouverture du tel:
  // - URL: https://stats.aperos.net/e/apero_catalan.call?to=tel%3A0652336461&src=app
  // =========================
  const TRACK_CALL_URL = "https://stats.aperos.net/e/apero_catalan.call?to=tel%3A0652336461&src=app";

  
  const TRACK_APP_URL = "https://stats.aperos.net/e/apero_catalan.app.click?to=https%3A%2F%2Fcatalan.aperos.net&src=app";
  const TRACK_AGE_ACCEPT_URL = "https://stats.aperos.net/e/apero_catalan.age.accept?to=https%3A%2F%2Fcatalan.aperos.net&src=agegate";
  const TRACK_AGE_REFUSE_URL = "https://stats.aperos.net/e/apero_catalan.age.refuse?to=https%3A%2F%2Fcatalan.aperos.net&src=agegate";

  function trackHit(url){
    try{
      // Ne doit jamais casser l'UX : tracking discret, sans navigation.
      if(navigator.sendBeacon){
        const blob = new Blob([], { type: "application/octet-stream" });
        navigator.sendBeacon(url, blob);
      } else {
        fetch(url, { method: "GET", mode: "no-cors", keepalive: true, cache: "no-store" }).catch(()=>{});
      }
    }catch(e){}
  }

function trackCallClick(){
    try{
      // sendBeacon = id√©al car non bloquant et fiable lors d'une navigation
      if (navigator.sendBeacon){
        const blob = new Blob([], { type: "text/plain" });
        navigator.sendBeacon(TRACK_CALL_URL, blob);
        return;
      }
    }catch(e){}

    // Fallback fetch (best-effort)
    try{
      fetch(TRACK_CALL_URL, { method: "GET", mode: "no-cors", cache: "no-store", keepalive: true })
        .catch(()=>{});
    }catch(e){}
  }

  const installBtnEl = document.getElementById('installBtn');
  const zoneBtnEl = document.getElementById('zoneBtn');
  const articlesBtnEl = document.getElementById('articlesBtn');

  callBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    requireMajorThen(() => {
      // üîé tracking (best-effort) avant l'ouverture du t√©l√©phone
      trackCallClick();
      window.location.href = callBtn.getAttribute('href') || 'tel:0652336461';
    });
  });// Zone + Articles : on emp√™che l'ouverture directe, et on ouvre apr√®s validation
  zoneBtnEl?.addEventListener('click', (e) => {
    e.preventDefault();
    requireMajorThen(() => openModal('zoneModal'));
  });

  articlesBtnEl?.addEventListener('click', (e) => {
    e.preventDefault();
    requireMajorThen(() => openModal('articlesModal'));
  });

  // Install : on laisse ensuite le code PWA g√©rer (on simule un clic apr√®s validation)
  installBtnEl?.addEventListener('click', (e) => {
    // IMPORTANT : on ne veut pas doubler le handler PWA plus bas.
    // Donc: on intercepte seulement si pas majeur.
    if (!ageIsMajorValid()) {
      e.preventDefault();
      e.stopImmediatePropagation();
      requireMajorThen(() => {
        // relance le clic une fois valid√©
        setTimeout(() => installBtnEl.click(), 0);
      });
    }
  }, true);
});
</script>

<!-- ‚úÖ Installation PWA (sans worker pour l‚Äôinstant) -->
<script>
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
const installHint = document.getElementById('installHint');

function isIOS() { return /iphone|ipad|ipod/i.test(navigator.userAgent); }
function isInStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}


function updatePlayBadgeVisibility(){
  const wrap = document.getElementById('playBadgeWrap');
  if (!wrap) return;
  // visible uniquement sur le site (browser), jamais en PWA/app
  if (isInStandalone()) {
    wrap.classList.add('hidden');
  } else {
    wrap.classList.remove('hidden');
  }
}
// ‚úÖ Cache/masquage CTA Play Store : jamais en mode PWA / app install√©e
(function(){
  const el = document.getElementById('playStoreBox');
  if (!el) return;
  const isStandalone2 =
    window.matchMedia('(display-mode: standalone)').matches ||
    window.matchMedia('(display-mode: fullscreen)').matches ||
    window.matchMedia('(display-mode: minimal-ui)').matches ||
    window.navigator.standalone === true;
  if (isStandalone2) el.classList.add('hidden');
})();


window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (!isInStandalone()) installBtn.classList.remove('hidden');
});

installBtn?.addEventListener('click', async (e) => {
  try {
    // iOS : on garde l'indication "Partager > Sur l‚Äô√©cran d‚Äôaccueil"
    if (isIOS()) {
      installHint?.classList.remove('hidden');
      return;
    }

    // Android / Web : redirection Play Store (fallback market://)
    const marketUrl = "market://details?id=net.aperos.catalan";
    const webUrl = "https://play.google.com/store/apps/details?id=net.aperos.catalan";

    // tracking best-effort (d√©j√† existant dans le fichier)
    try { trackHit(TRACK_APP_URL); } catch(e){}

    // option UX : on masque le bouton apr√®s clic (logique "disparition" conserv√©e)
    installBtn?.classList.add('hidden');

    // Tentative d'ouverture market:// (peut √©chouer en in-app browser)
    let opened = false;
    try {
      window.location.href = marketUrl;
      opened = true;
    } catch(err){}

    // Fallback web apr√®s un court d√©lai
    setTimeout(() => {
      if (!opened) return;
      window.location.href = webUrl;
    }, 450);

    // Si le navigateur bloque market://, on force le web URL
    setTimeout(() => {
      window.location.href = webUrl;
    }, 900);
  } catch(err) {
    window.location.href = "https://play.google.com/store/apps/details?id=net.aperos.catalan";
  }
});
window.addEventListener('appinstalled', () => {
  deferredPrompt = null;
  installBtn?.classList.add('hidden');
});

window.addEventListener('load', () => {
  if (isIOS() && !isInStandalone()) {
    setTimeout(() => {
      installBtn.classList.remove('hidden');
      installBtn.addEventListener('click', () => {
        installHint.classList.remove('hidden');
      }, { once: true });
    }, 800);
  }
});
</script>

<!-- ===== GLOBAL STATUS POPUP (commun aux 2 sites) ===== -->
<div id="globalStatusOverlay" class="fixed inset-0 z-[999997] hidden items-center justify-center p-4 bg-black/70 backdrop-blur-md">
  <div class="w-[min(560px,94vw)] overflow-hidden rounded-3xl border border-white/10 shadow-2xl"
       style="background: radial-gradient(900px 650px at 50% 18%, rgba(255,211,107,.18), transparent 58%),
              radial-gradient(900px 650px at 20% 70%, rgba(198,25,16,.22), transparent 62%),
              radial-gradient(900px 650px at 80% 70%, rgba(255,184,28,.14), transparent 62%),
              linear-gradient(180deg, #5a1217, #2a0a0c 55%, #120406);">
    <div class="p-3 flex items-center justify-between gap-3 border-b border-white/10 bg-white/5">
      <div class="flex items-center gap-2 min-w-0">
        <div class="w-9 h-9 rounded-2xl grid place-items-center font-black tracking-wider text-white border border-white/10"
             style="background: rgba(198,25,16,.20);">!</div>
        <div class="min-w-0">
          <div class="text-[12px] tracking-[.18em] font-black text-white/90 whitespace-nowrap overflow-hidden text-ellipsis">INFORMATION SERVICE</div>
          <div class="text-[12px] text-white/70 -mt-[2px]">Mise √† jour officielle</div>
        </div>
      </div>
      <button id="globalStatusCloseX" class="w-10 h-10 rounded-2xl grid place-items-center text-white/80 hover:text-white hover:bg-white/10 border border-white/10">
        <i class="ri-close-line text-xl"></i>
      </button>
    </div>

    <img id="globalStatusImg" alt="" class="w-full h-auto block bg-black/20">

    <div class="p-5">
      <h2 id="globalStatusTitle" class="text-white text-2xl font-black leading-tight mb-2">Service temporairement suspendu</h2>
      <p id="globalStatusMsg" class="text-white/80 text-[15px] leading-relaxed">
        Une information importante est en cours.
      </p>

      <div class="mt-4 grid gap-2">
        <button id="globalStatusOk"
                class="w-full py-4 !rounded-button font-black tracking-wide text-white bg-primary hover:opacity-95 transition">
          OK, j'ai compris
        </button>
      </div>

      <div class="mt-3 text-[12px] text-white/60 text-center">
        L‚Äôabus d‚Äôalcool est dangereux pour la sant√©, √† consommer avec mod√©ration.
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Lecture du statut commun (status.json) ===== */
(function() {
  const STATUS_URL = 'https://bullyto.github.io/status/status.json';

  const overlay = document.getElementById('globalStatusOverlay');
  const imgEl   = document.getElementById('globalStatusImg');
  const titleEl = document.getElementById('globalStatusTitle');
  const msgEl   = document.getElementById('globalStatusMsg');
  const btnOk   = document.getElementById('globalStatusOk');
  const btnX    = document.getElementById('globalStatusCloseX');

  // (optionnel) zone message secondaire si warning
  let secondary = document.getElementById('globalStatusSecondary');
  if(!secondary){
    const div = document.createElement('div');
    div.id = 'globalStatusSecondary';
    div.className = "mt-3 text-[13px] text-white/85 text-center font-semibold";
    div.style.display = "none";
    btnOk?.parentElement?.appendChild(div);
    secondary = div;
  }

  if(!overlay || !imgEl || !titleEl || !msgEl || !btnOk) return;

  let canClose = true;
  let currentMode = "none";
  let warningClickMsg = "Ce n'est actuellement pas possible de commander.";

  function setCloseEnabled(on){
    canClose = !!on;

    if(btnX){
      btnX.disabled = !canClose;
      btnX.style.opacity = canClose ? "" : "0.5";
      btnX.style.cursor = canClose ? "" : "not-allowed";
      btnX.classList.toggle("pointer-events-none", !canClose);
    }

    if(currentMode === "info"){
      btnOk.disabled = !canClose;
      btnOk.style.opacity = canClose ? "" : "0.7";
      btnOk.style.cursor = canClose ? "" : "not-allowed";
      btnOk.classList.toggle("pointer-events-none", !canClose);
    } else {
      btnOk.disabled = false;
      btnOk.style.opacity = "";
      btnOk.style.cursor = "pointer";
      btnOk.classList.remove("pointer-events-none");
    }
  }

  function close() {
    if(!canClose) return;
    overlay.classList.add('hidden');
    overlay.classList.remove('flex');
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
  }

  function open() {
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
  }

  overlay.addEventListener('click', (e) => {
    if(e.target === overlay) {
      if(canClose) close();
      else if(currentMode === "warning" && secondary){
        secondary.style.display = "block";
        secondary.textContent = warningClickMsg;
      }
    }
  });

  document.addEventListener("keydown", (e) => {
    if(overlay.classList.contains("flex") && e.key === "Escape"){
      if(!canClose){
        e.preventDefault();
        e.stopPropagation();
      } else {
        close();
      }
    }
  }, true);

  btnOk.addEventListener('click', () => {
    if(currentMode === "warning"){
      if(secondary){
        secondary.style.display = "block";
        secondary.textContent = warningClickMsg;
        secondary.style.opacity = "1";
        setTimeout(()=> secondary.style.opacity = "0.85", 250);
      }
      return;
    }
    close();
  });

  if(btnX) btnX.addEventListener('click', close);

  function withinSchedule(schedule, now = new Date()){
    if(!schedule || !schedule.enabled) return true;

    const days = Array.isArray(schedule.days) ? schedule.days : [];
    const day = now.getDay();
    if(days.length && !days.includes(day)) return false;

    const [sh, sm] = String(schedule.start||"00:00").split(":").map(n=>parseInt(n,10));
    const [eh, em] = String(schedule.end||"00:00").split(":").map(n=>parseInt(n,10));
    if(!Number.isFinite(sh)||!Number.isFinite(sm)||!Number.isFinite(eh)||!Number.isFinite(em)) return true;

    const startMin = sh*60+sm;
    const endMin = eh*60+em;
    const nowMin = now.getHours()*60+now.getMinutes();

    if(startMin === endMin) return true;
    if(startMin < endMin){
      return nowMin >= startMin && nowMin < endMin;
    } else {
      return (nowMin >= startMin) || (nowMin < endMin);
    }
  }

  function setOrderEnabled(enabled){
    const callBtn = document.getElementById("callBtn");
    const orderLinks = Array.from(document.querySelectorAll('a[href^="tel:"]'));
    const all = new Set([callBtn, ...orderLinks].filter(Boolean));
    all.forEach(el => {
      if(enabled){
        el.classList.remove("pointer-events-none","opacity-50");
        el.removeAttribute("aria-disabled");
        el.dataset.statusBlocked = "0";
      } else {
        el.classList.add("pointer-events-none","opacity-50");
        el.setAttribute("aria-disabled","true");
        el.dataset.statusBlocked = "1";
      }
    });
  }

  document.addEventListener("click", (e) => {
    const a = e.target.closest('a[href^="tel:"]');
    if(!a) return;
    if(a.dataset.statusBlocked === "1"){
      e.preventDefault();
      if(currentMode === "warning" && secondary){
        secondary.style.display = "block";
        secondary.textContent = warningClickMsg;
      }
    }
  }, true);

  fetch(STATUS_URL, { cache: "no-store" })
    .then(r => r.json())
    .then(data => {
      if(!data || !data.active) { setOrderEnabled(true); return; }

      const mode = data.mode || "none";
      const cfg = data.modes && data.modes[mode];
      if(!cfg) { setOrderEnabled(true); return; }

      currentMode = mode;

      const base = STATUS_URL.replace(/\/status\.json$/,'/');
      const imgUrl = (cfg.image || "").startsWith("http") ? cfg.image : (base + (cfg.image || ""));

      imgEl.src = imgUrl;
      titleEl.textContent = cfg.title || "Information";
      msgEl.textContent = cfg.message || "";

      if(mode === "info"){
        const delay = Number.isFinite(cfg.ok_delay_seconds) ? cfg.ok_delay_seconds : 5;
        if(btnOk) btnOk.textContent = `OK, j'ai compris (dans ${delay}s)`;
        if(secondary) secondary.style.display = "none";

        setCloseEnabled(false);
        setOrderEnabled(true);
        open();

        let left = delay;
        const t = setInterval(() => {
          left -= 1;
          if(left <= 0){
            clearInterval(t);
            if(btnOk) btnOk.textContent = "OK, j'ai compris";
            setCloseEnabled(true);
          } else {
            if(btnOk) btnOk.textContent = `OK, j'ai compris (dans ${left}s)`;
          }
        }, 1000);
        return;
      }

      if(mode === "warning"){
        warningClickMsg = cfg.warning_click_message || warningClickMsg;
        if(secondary){
          secondary.style.display = "none";
          secondary.textContent = warningClickMsg;
        }

        const schedule = cfg.block_schedule || { enabled:false };
        const blockedNow = withinSchedule(schedule, new Date());

        // ‚úÖ WARNING ne bloque QUE pendant la plage horaire
        if(!blockedNow){
          setOrderEnabled(true);
          close(); // ferme si jamais affich√©e
          return;
        }

        // ‚úÖ dans la plage => warning bloquant + commande bloqu√©e
        setCloseEnabled(false);
        setOrderEnabled(false);

        open();
        return;
      }

      setOrderEnabled(true);
    })
    .catch(() => { setOrderEnabled(true); });
})();
</script>


<script>
(function(){
  const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  const overlay = document.getElementById('pwaLoading');
  if(!isPWA && overlay){ overlay.remove(); return; }
  if(isPWA && overlay){
    setTimeout(()=>overlay.remove(),2700);
  }
})();
</script>


<script>
// Service Worker (offline + cache)
(function(){
  if (!('serviceWorker' in navigator)) return;
  // Avoid double-registration
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { scope: './' })
      .then(reg => {
        // If there's a waiting SW, activate it ASAP
        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        // When a new SW is found, prompt it to take over quickly
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed') {
              // New version installed; ask it to activate
              if (navigator.serviceWorker.controller) {
                sw.postMessage({ type: 'SKIP_WAITING' });
              }
            }
          });
        });
        // Reload once when controller changes (new SW takes over)
        let reloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (reloaded) return;
          reloaded = true;
          window.location.reload();
        });
      })
      .catch(()=>{});
  });
})();
</script>


<script>
// PWA loader: exactly 2.7s, only when installed (standalone)
(function(){
  const overlay = document.getElementById('pwaLoading');
  if (!overlay) return;
  const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (!isPWA) { overlay.remove(); return; }
  // Let the app load in the background while we show the loader
  window.setTimeout(() => overlay.remove(), 2700);
})();
</script>

</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Ap√©ro de Nuit 66</title>

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1c2d">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

  <!-- Pr√©chargement -->
  <link rel="preload" as="image" href="assets/logo-header.png">
  <link rel="preload" as="image" href="assets/bottle1.png">
  <link rel="preload" as="image" href="assets/bottle2.png">
  <link rel="preload" as="image" href="assets/bottle3.png">
  <link rel="preload" as="image" href="assets/bottle4.png">
  <link rel="preload" as="image" href="assets/bottle5.png">
  <link rel="preload" as="image" href="assets/bottle6.png">
  <link rel="preload" as="image" href="assets/bottle7.png">

  <style>
    :root{ --blue:#0b1c2d; --sky:#5db7ee; --text:#0b1c2d; }
    *{box-sizing:border-box}

    body{
      margin:0; height:100dvh; display:flex; flex-direction:column;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#fff; color:var(--text); overflow:hidden;
    }

    /* HEADER */
    .top{background:var(--blue);padding-bottom:8px}
    .top img{width:100%;max-height:26vh;object-fit:contain;display:block}

    /* TITRE */
    .mid{text-align:center;padding:18px 14px 6px}
    .mid h1{margin:0;font-size:clamp(26px,6vw,40px);color:var(--sky);font-weight:900}
    .brand66{position:relative;display:inline-block}
    .brand66 .reg{position:absolute;top:-0.2em;right:-0.4em;font-size:1em;font-weight:800}

    /* ZONE BOUTEILLES */
    .stage{flex:1;display:flex;justify-content:center;padding:12px}
    .bottleWrap{
      position:relative;width:min(520px,96vw);min-height:60vh;
      display:flex;justify-content:center;align-items:flex-start;
    }
    .bottleWrap img{
      position:absolute;max-height:56vh;max-width:100%;width:auto;
      opacity:0;transition:opacity .4s ease;
    }
    .bottleWrap img.active{opacity:1}

    /* BOUTONS */
    
.btnStack{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:min(420px,86vw);
  z-index:50;
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:center;
  justify-content:center;
  padding:0 12px;
}
    .btn{
      width:100%;border:none;border-radius:16px;padding:14px;
      font-size:18px;font-weight:900;cursor:pointer;
      position:relative;
    }
        .btn.primary{background:var(--sky);color:#fff}
    .btn.secondary{background:rgba(255,255,255,.85);color:#0b1c2d;border:1px solid rgba(11,28,45,.25)}

    /* Pulse */
    @keyframes pulseAdd {
      0%   { box-shadow: 0 0 0 0 rgba(93,183,238,.45); transform: translateY(0); }
      60%  { box-shadow: 0 0 0 16px rgba(93,183,238,0); }
      100% { box-shadow: 0 0 0 0 rgba(93,183,238,0); }
    }
    .btn.secondary.pulse { animation: pulseAdd 2.6s infinite; }

    /* Badge "Nouveau" */
    .badge-new{
      position:absolute;
      top:-8px;
      right:-8px;
      background:var(--sky);
      color:#fff;
      font-size:11px;
      font-weight:950;
      padding:4px 8px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(93,183,238,.45);
      letter-spacing:.2px;
      border:2px solid rgba(255,255,255,.85);
      pointer-events:none;
    }

    /* MODALE */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      padding:18px;background:rgba(0,0,0,.55);z-index:999;
    }
    .modal.open{display:flex}
    .sheet{
      width:min(520px,94vw);background:#fff;border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);padding:18px 16px 14px;
    }
    .sheetHead{display:flex;gap:12px;margin-bottom:8px;align-items:flex-start}
    .sheetIcon{
      width:40px;height:40px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      background:rgba(93,183,238,.18);font-size:20px;
    }
    .sheet h3{margin:0;font-size:18px;color:var(--blue);line-height:1.2}
    .sheet p{margin:10px 0;color:rgba(0,0,0,.75);font-size:14px;line-height:1.35}
    .step{
      background:rgba(11,28,45,.06);border:1px solid rgba(11,28,45,.08);
      border-radius:16px;padding:10px 12px;margin:10px 0;font-size:14px;line-height:1.35;
    }
    .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .okBtn,.copyBtn{border:none;border-radius:14px;padding:12px 16px;font-weight:900;cursor:pointer;}
    .okBtn{background:var(--sky);color:#fff;min-width:110px}
    .copyBtn{background:rgba(93,183,238,.18);color:var(--blue)}
    .copied{font-size:13px;color:#1b7f2a;margin-top:6px;display:none}

    /* TOAST */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(20px);
      opacity:0;
      pointer-events:none;
      background:rgba(11,28,45,.92);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      z-index:1000;
      transition:opacity .25s ease, transform .25s ease;
      font-weight:900;
      font-size:14px;
      width:min(520px, 92vw);
      text-align:center;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* =========================
       üîû AGE GATE
       ========================= */
    .ageOverlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:5000;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .ageOverlay.show{display:flex;}

    .ageCard{
      width:min(560px, 94vw);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(20,35,56,.94), rgba(10,20,33,.94));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
      color:#fff;
    }
    .ageTop{
      padding:16px 18px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .ageBrand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .ageBadge{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: rgba(93,183,238,.18);
      border:1px solid rgba(93,183,238,.30);
      font-weight:950;color:#5db7ee;
      flex:0 0 auto;
    }
    .ageBrand b{
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:14px;
      color:rgba(255,255,255,.88);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .ageBody{padding:18px;}
    .ageTitle{margin:6px 0 10px;font-size:28px;line-height:1.1;font-weight:950}
    .ageLead{margin:0 0 14px;color:rgba(255,255,255,.74);line-height:1.45;font-size:15px}
    .ageNotice{
      margin:14px 0 18px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.88);
      font-size:14px;
      line-height:1.35;
    }
    .ageBtns{display:grid; gap:10px; margin-top:10px;}
    .ageBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(19,36,59,.90);
      color:#fff;
      padding:14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:950;
      font-size:15px;
    }
    .ageBtnPrimary{
      background: linear-gradient(180deg, rgba(40,199,111,1), rgba(24,160,86,1));
      border-color: rgba(40,199,111,.55);
      box-shadow: 0 14px 40px rgba(40,199,111,.22);
    }
    .ageBtnSecondary{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
    }
    .ageTimer{
      margin-top:12px;
      font-weight:950;
      color:#5db7ee;
      text-align:center;
      font-size:16px;
    }
    .ageFine{
      margin:12px 0 0;
      color: rgba(255,255,255,.60);
      font-size:12.5px;
      line-height:1.35;
      text-align:center;
    }
    .ageFine a{color:#5db7ee; text-decoration:none; font-weight:900;}
    .ageFine a:hover{text-decoration:underline;}
  </style>
</head>

<body>
  <header class="top">
    <img src="assets/logo-header.png" alt="">
  </header>

  <section class="mid">
    <h1>AP√âRO DE NUIT <span class="brand66">66<span class="reg">¬Æ</span></span></h1>
  </section>

  <main class="stage">
    <div class="bottleWrap" id="bottles">
      <img src="assets/bottle1.png" class="active" alt="">
      <img src="assets/bottle2.png" alt="">
      <img src="assets/bottle3.png" alt="">
      <img src="assets/bottle4.png" alt="">
      <img src="assets/bottle5.png" alt="">
      <img src="assets/bottle6.png" alt="">
      <img src="assets/bottle7.png" alt="">

      <div class="btnStack">
        <button class="btn primary" id="goBtn">Commander</button>

        <button class="btn secondary pulse" id="installBtn" style="display:none">
          Ajouter l‚Äôapp
          <span class="badge-new" id="newBadge">Nouveau</span>
        </button>

        <button class="btn secondary" id="promoBtn" style="display:none">
          Code promo
          <span class="badge-new" id="promoBadge">Nouveau</span>
        </button>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast">‚úÖ Ap√©ro de Nuit est ajout√© √† ton √©cran d‚Äôaccueil !</div>

  <!-- Modale help install -->
  <div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="sheet">
      <div class="sheetHead">
        <div class="sheetIcon" id="helpIcon">üì≤</div>
        <div>
          <h3 id="helpTitle">Installer l‚Äôapp</h3>
          <p id="helpIntro"></p>
        </div>
      </div>

      <div class="step" id="helpSteps"></div>
      <div class="copied" id="copiedMsg">‚úÖ Lien copi√©</div>

      <div class="modalActions">
        <button class="copyBtn" id="copyLinkBtn" style="display:none">Copier le lien</button>
        <button class="okBtn" id="closeHelp">OK</button>
      </div>
    </div>
  </div>

  <!-- üîû AGE GATE -->
  <div class="ageOverlay" id="ageQuestion" role="dialog" aria-modal="true">
    <div class="ageCard">
      <div class="ageTop">
        <div class="ageBrand">
          <div class="ageBadge">AD</div>
          <b>AP√âRO DE NUIT</b>
        </div>
      </div>
      <div class="ageBody">
        <div class="ageTitle">Bienvenue ‚ú®</div>
        <p class="ageLead">
          Ce site pr√©sente des boissons alcoolis√©es. Pour continuer, confirme que tu as l‚Äô√¢ge l√©gal.
        </p>
        <div class="ageNotice">
          <b>La vente d‚Äôalcool est interdite aux mineurs.</b><br>
          L‚Äôabus d‚Äôalcool est dangereux pour la sant√©, √† consommer avec mod√©ration.
        </div>
        <div class="ageBtns">
          <button class="ageBtn ageBtnPrimary" id="ageYes">‚úÖ Je suis majeur</button>
          <button class="ageBtn ageBtnSecondary" id="ageNo">‚ÑπÔ∏è Je ne suis pas majeur</button>
        </div>
        <div class="ageFine">üîí Choix m√©moris√© 7 jours sur cet appareil.</div>
      </div>
    </div>
  </div>

  <div class="ageOverlay" id="ageBlocked" role="dialog" aria-modal="true">
    <div class="ageCard">
      <div class="ageTop">
        <div class="ageBrand">
          <div class="ageBadge">18+</div>
          <b>ACC√àS R√âSERV√â</b>
        </div>
      </div>
      <div class="ageBody">
        <div class="ageTitle">Acc√®s r√©serv√© üîû</div>
        <p class="ageLead">
          Ce contenu est strictement r√©serv√© aux personnes majeures.<br>
          La vente d‚Äôalcool est interdite aux mineurs.
        </p>
        <div class="ageNotice">
          Pour acc√©der au contenu, une v√©rification d‚Äô√¢ge est obligatoire.
        </div>
        <div class="ageTimer">
          Nouvelle tentative dans <span id="ageCount">20</span>s
        </div>
        <div class="ageFine">
          Si tu penses √™tre bloqu√© par erreur, contacte Ap√©ro de Nuit (page contact / r√©seaux)
          ou <a href="mailto:contact@aperodenuit.com">contact@aperodenuit.com</a>.
        </div>
        <div class="ageFine" style="margin-top:10px;">
          L‚Äôabus d‚Äôalcool est dangereux pour la sant√©.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ Service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    // D√©filement bouteilles (2s)
    const imgs = document.querySelectorAll("#bottles img");
    let idx = 0;
    if (imgs.length > 1) {
      setInterval(() => {
        imgs[idx].classList.remove("active");
        idx = (idx + 1) % imgs.length;
        imgs[idx].classList.add("active");
      }, 2000);
    }

    // D√©tections
    const ua = navigator.userAgent || "";
    const isFBInApp = /FBAN|FBAV|FB_IAB|FB4A|FB4i|Instagram/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    // PWA prompt Android/Chrome
    let deferredPrompt = null;
      deferredPrompt = e;
      // quand Chrome peut proposer l'installation, on force l'UI "install visible"
      // (√ßa aide si un flag local √©tait faux)
      updateInstallUI();
    });

    // Toast
    const toastEl = document.getElementById("toast");
    function showToast(msg){
      if(msg) toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 2600);
    }

    // ‚úÖ Standalone (PWA)
    function isStandalone(){
      return window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true; // iOS
    }

    // ===============================
    // ‚úÖ LOGIQUE INSTALL "FIABLE"
    // ===========// ===============================
// ‚úÖ INSTALL APP : affichage fiable
// - Bouton cach√© par d√©faut
// - S'affiche seulement si Chrome autorise l'installation
// - Dispara√Æt si d√©j√† install√© (standalone ou flag)
// ===============================
const installBtn = document.getElementById("installBtn");

const INSTALL_FLAG_KEY = "pwa_installed_flag_v1";

function setInstalledFlag(v){ try{ localStorage.setItem(INSTALL_FLAG_KEY, v ? "1" : "0"); }catch(e){} }
function getInstalledFlag(){ try{ return localStorage.getItem(INSTALL_FLAG_KEY) === "1"; }catch(e){ return false; } }

function isStandalone(){
  return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
}

// Cache/affiche le bouton (par d√©faut cach√©)
function applyInstallUI(installed){
  if(!installBtn) return;
  installBtn.style.display = installed ? "none" : (deferredPrompt ? "block" : "none");
  if(installed) installBtn.classList.remove("pulse");
  else installBtn.classList.add("pulse");
}

// Check initial : si on est dans la PWA => install√©
(function initInstallUI(){
  if (isStandalone()) {
    setInstalledFlag(true);
    applyInstallUI(true);
  } else if (getInstalledFlag()) {
    // Permet de cacher le bouton dans Chrome si l'app a d√©j√† √©t√© install√©e sur cet appareil
    applyInstallUI(true);
  } else {
    // On attend beforeinstallprompt pour afficher
    applyInstallUI(false);
  }
})();

// Quand Chrome autorise l'installation => on peut afficher le bouton
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Si l'utilisateur a d√©sinstall√© l'app, cet event va r√©apparaitre :
  // on nettoie le flag pour r√©afficher le bouton.
  setInstalledFlag(false);
  applyInstallUI(false);
});

// Quand l'installation est termin√©e
window.addEventListener("appinstalled", () => {
  setInstalledFlag(true);
  applyInstallUI(true);
  showToast("‚úÖ Ap√©ro de Nuit est ajout√© √† ton √©cran d‚Äôaccueil !");
});

// Recheck au retour d'onglet (ex: installation faite puis retour)
document.addEventListener("visibilitychange", () => {
  if (!document.hidden && isStandalone()) {
    setInstalledFlag(true);
    applyInstallUI(true);
  }
});

    ick", async () => {
      if (isFBInApp) {
        openModal({
          ic:"üì£",
          t:"Ouvrir dans un navigateur",
          i:"Facebook / Instagram bloque l‚Äôinstallation de l‚Äôapp.",
          s:
            "<strong>Solution :</strong><br><br>" +
            "1) Clique sur <strong>Copier le lien</strong><br>" +
            "2) Ouvre <strong>Chrome</strong> (Android) ou <strong>Safari</strong> (iPhone)<br>" +
            "3) Colle le lien dans la barre d‚Äôadresse, puis re-clique sur <strong>Ajouter l‚Äôapp</strong>",
          showCopy:true
        });
        return;
      }

      if (deferredPrompt) {
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; } catch(e) {}
        deferredPrompt = null;
        // apr√®s tentative d'install, on re-check
        setTimeout(updateInstallUI, 600);
        return;
      }

      if (isIOS && isSafari) {
        openModal({
          ic:"üçè",
          t:"Ajouter √† l‚Äô√©cran d‚Äôaccueil",
          i:"Sur iPhone, l‚Äôinstallation se fait via le bouton Partager.",
          s:
            "<strong>√âtapes :</strong><br><br>" +
            "1) Appuie sur <strong>Partager</strong> (carr√© + fl√®che)<br>" +
            "2) Choisis <strong>Sur l‚Äô√©cran d‚Äôaccueil</strong><br>" +
            "3) Valide <strong>Ajouter</strong>"
        });
        return;
      }

      openModal({
        ic:"‚ö†Ô∏è",
        t:"Installation indisponible",
        i:"Ton navigateur ne propose pas l‚Äôinstallation automatique.",
        s:
          "Essaie avec <strong>Chrome</strong> (Android) ou <strong>Safari</strong> (iPhone).<br>" +
          "Si tu es sur une appli (Facebook, etc.), ouvre le lien dans un navigateur.",
        showCopy:true
      });
    });

    // ‚úÖ Commander -> passe par Age Gate + promo
    document.getElementById("goBtn").addEventListener("click", () => {
      requireMajorThen(() => {
        promoKickoffAfterCommander();
        window.location.href = AGE.commanderUrl;
      });
    });
  </script>
</body>
</html>
